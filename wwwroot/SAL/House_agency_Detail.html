<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link href="../_include/main.css" rel="stylesheet" type="text/css">
    <script src="../Base.js"></script>
    <title>作業平台 - 委對單明細</title>
</head>
<body>

    <table width="720" border="1" cellspacing="0" cellpadding="3" bgcolor="#6666FF">
        <tbody>
            <tr class="14-k" bgcolor="#FFFFFF" height="35" align="center">
                <td colspan="2"><label id="lb_fun">委對單</label> </td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td width="120">案件單位</td>
                <td width="600" align="left"><input type="text" class="text_box_1" name="case_com" size="10" style="width:120px;" maxlength="30" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保單位</td>
                <td align="left"><input type="text" class="text_box_1" name="agency_com" size="10" style="width:120px;" maxlength="30" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>案件AO / 電話</td>
                <td align="left"><input type="text" class="text_box_1" name="case_text" size="10" style="width:580px;" maxlength="100" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>客戶姓名 / 電話</td>
                <td align="left"><input type="text" class="text_box_1" name="CS_text" size="10" style="width:580px;" maxlength="100" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保日期 / 時間</td>
                <td align="left"><input type="text" class="text_box_1" name="check_date" size="10" style="width:580px;" maxlength="100" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保地點</td>
                <td align="left"><input type="text" class="text_box_1" name="check_address" size="10" style="width:580px;" maxlength="100" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>核貸金額</td>
                <td align="left"><input type="text" class="text_box_1" name="pass_amount" size="10" style="width:200px;" maxlength="50" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>本票及設定金額</td>
                <td align="left"><input type="text" class="text_box_1" name="set_amount" size="10" style="width:200px;" maxlength="50" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>需影印資料</td>
                <td align="left"><input type="text" class="text_box_1" name="print_data" size="10" style="width:580px;" maxlength="100" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>代收資料</td>
                <td align="left"><input type="text" class="text_box_1" name="get_data" size="10" style="width:580px;" maxlength="100" value=""></td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>車馬費</td>
                <td align="left"><input type="text" class="text_box_1" name="process_charge" size="10" style="width:200px;" maxlength="50" value=""></td>
            </tr>
            <tr class="14-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>備註</td>
                <td align="left" colspan="1">
                    <textarea id="AG_note" name="AG_note" cols="80" rows="6"></textarea>
                </td>
            </tr>
            <tr class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保單位主管</td>
                <td align="left">
                    <input type="hidden" name="check_leader_num" id="U_leader_1_num" value="">
                    <input type="text" name="check_leader_name" id="U_leader_1_name" size="10" maxlength="10" class="box" value="" readonly="">
                    <input type="button" value="..." id="btCheck_leader_num" name="_select_user_one_leader" onclick="openUserOne('leader1')">
                </td>
            </tr>
            <tr id="tr_check_process_num" class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保人員</td>
                <td align="left">
                    <input type="hidden" name="check_process_num" id="U_num" value="">
                    <input type="text" name="check_process_name" id="U_name" size="10" maxlength="10" class="box" value="" readonly="">
                    <input type="button" value="..." id="btCheck_process_num" name="_select_user_one_process" onclick="openUserOne('appUser')">
                    <label id="set_process_date"></label>
                </td>
            </tr>
            <tr id="tr_check_process_type" class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保處理進度</td>
                <td align="left">
                    <div id="divCheck_process_type">
                        <input type="radio" id="check_process_type_N" name="check_process_type" value="N" /> <label for="check_process_type_N">尚未對保</label>
                        <input type="radio" id="check_process_type_Y" name="check_process_type" value="Y" /> <label for="check_process_type_Y">對保完成</label>
                    </div>
                    <label id="check_process_date"></label>
                </td>
            </tr>
            <tr id="tr_check_process_note" class="12-k" bgcolor="#FFFFFF" height="25" align="center">
                <td>對保備註</td>
                <td align="left">
                    <input type="text" id="check_process_note" name="check_process_note" size="15" style="width:580px;" maxlength="100" class="box" value="">
                    <label id="lbCheck_process_note"></label>
                </td>
            </tr>
            <tr class="c12-k" bgcolor="#FFFFFF" id="tr_close_type" height="25" align="center">
                <td>是否結案</td>
                <td align="left">
                    <input type="radio" id="close_type_N" name="close_type" value="N" /> <label for="close_type_N">未結案</label>
                    <input type="radio" id="close_type_Y" name="close_type" value="Y" /> <label for="close_type_Y">已結案</label>
                    <label id="close_type_date_label"></label>
                </td>
            </tr>
            <tr class="14-k" bgcolor="#FFFFFF" height="35" align="center">
                <td align="center" colspan="2">
                    <input type="button" id="btnSave" name="btnSave" value="確定" onclick="saveData();" />
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
<script>
    let Params = new URLSearchParams(window.location.search);
    let Id = decryptParameter(Params.get('Id'));
    let WebUser = decryptParameter(Params.get('User'));
    let Opt = decryptParameter(Params.get('Opt'));

    let Before_check_process_type = '';
    let Before_check_process_num = '';
    let Before_close_type = '';

    window.onload = function() {
        dateTW();
        fetchData();
        ShowMode();
    };

    // 將 ISO 日期字串轉換為本地化格式 YYYY/M/D 上午/下午 HH:MM:SS
    function formatCustomDateTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date)) return '';

        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();

        let hours = date.getHours();
        const minutes = date.getMinutes();
        const seconds = date.getSeconds();

        const ampm = hours >= 12 ? '下午' : '上午';

        hours = hours % 12;
        hours = hours ? hours : 12;

        const pad = (num) => num.toString().padStart(2, '0');

        return `${year}/${month}/${day} ${ampm} ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    function fetchData() {
        if (Id && Id !== 'add') {
            const url = `${BASE_URL}/AE_SAL/House_agency_SQuery?Id=${Id}`;
            fetch(url)
                .then(response => response.json())
                .then(response => {
                    if (response.resultCode === '000') {
                        const data = JSON.parse(response.objResult)[0];

                        $("input[name='case_com']").val(data.case_com);
                        $("input[name='agency_com']").val(data.agency_com);
                        $("input[name='case_text']").val(data.case_text);
                        $("input[name='CS_text']").val(data.CS_text);
                        $("input[name='check_date']").val(data.check_date);
                        $("input[name='check_address']").val(data.check_address);
                        $("input[name='pass_amount']").val(data.pass_amount);
                        $("input[name='set_amount']").val(data.set_amount);
                        $("input[name='print_data']").val(data.print_data);
                        $("input[name='get_data']").val(data.get_data);
                        $("input[name='process_charge']").val(data.process_charge);
                        $('textarea#AG_note').val(data.AG_note);

                        $("input[name='check_leader_num']").val(data.check_leader_num);
                        $("input[name='check_leader_name']").val(data.check_leader_name);
                        $("input[name='check_process_num']").val(data.check_process_num);
                        $("input[name='check_process_name']").val(data.check_process_name);
                        $("input[name='check_process_note']").val(data.check_process_note);

                        Before_check_process_num = data.check_process_num || '';
                        Before_check_process_type = data.check_process_type || 'N';
                        Before_close_type = data.close_type || 'N';

                        let lbcheck_process_type = data.check_process_type === 'Y' ? '對保完成' : '尚未對保';
                        $(`input[name='check_process_type'][value='${data.check_process_type || 'N'}']`).prop('checked', true);
                        $('#lbCheck_process_note').text(data.check_process_note || '');

                        // 使用格式化函式來顯示日期
                        if (data.check_process_date) {
                            $('#check_process_date').text(`${lbcheck_process_type} / 日期：${formatCustomDateTime(data.check_process_date)}`);
                        }

                        if (data.set_process_date) {
                            $('#set_process_date').text(`分配日期: ${formatCustomDateTime(data.set_process_date)}`);
                        }

                        $(`input[name='close_type'][value='${data.close_type || 'N'}']`).prop('checked', true);
                        if (data.close_type === 'Y' && data.close_type_date) {
                            $('#close_type_date_label').text(`／ 日期：${formatCustomDateTime(data.close_type_date)}`);
                        }
                    } else {
                        alert(response.resultMsg || '讀取資料失敗');
                    }
                })
                .catch(error => {
                    console.error('API 請求失敗:', error);
                    alert('API 請求失敗，請洽詢資訊人員。');
                });
        }
    }

    function saveData() {
        const hasProcessTypeChanged = $("input[name='check_process_type']:checked").val() !== Before_check_process_type;
        const hasProcessNumChanged = $("input[name='check_process_num']").val() !== Before_check_process_num;
        const hasCloseTypeChanged = $("input[name='close_type']:checked").val() !== Before_close_type;

        let formData = {
            AG_id: Id === 'add' ? 0 : Id,
            case_com: $("input[name='case_com']").val(),
            agency_com: $("input[name='agency_com']").val(),
            case_text: $("input[name='case_text']").val(),
            CS_text: $("input[name='CS_text']").val(),
            check_date: $("input[name='check_date']").val(),
            check_address: $("input[name='check_address']").val(),
            pass_amount: $("input[name='pass_amount']").val(),
            set_amount: $("input[name='set_amount']").val(),
            print_data: $("input[name='print_data']").val(),
            get_data: $("input[name='get_data']").val(),
            process_charge: $("input[name='process_charge']").val(),
            AG_note: $('textarea#AG_note').val(),
            check_leader_num: $("input[name='check_leader_num']").val(),
            check_process_num: $("input[name='check_process_num']").val(),
            set_process_date: hasProcessNumChanged ? new Date().toISOString() : null,
            check_process_type: $("input[name='check_process_type']:checked").val() || null,
            check_process_note: $("input[name='check_process_note']").val(),
            check_process_date: hasProcessTypeChanged ? new Date().toISOString() : null,
            close_type: $("input[name='close_type']:checked").val() || null,
            close_type_date: hasCloseTypeChanged && $("input[name='close_type']:checked").val() === 'Y' ? new Date().toISOString() : null,
            add_num: WebUser,
            edit_num: WebUser
        };

        const isAdd = (Id === 'add');
        const url = isAdd ? `${BASE_URL}/AE_SAL/House_agency_Ins` : `${BASE_URL}/AE_SAL/House_agency_Upd`;
        const method = 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(response => {
            if (response.resultCode === '000') {
                alert(isAdd ? '新增成功' : '修改成功');
                if (window.opener) {
                    window.opener.location.reload();
                }
                window.close();
            } else {
                alert(response.resultMsg || '操作失敗');
            }
        })
        .catch(error => {
            console.error('請求失敗:', error);
            alert('請求失敗，請稍後再試。');
        });
    }

    function ShowMode() {
        const saveButton = $('#btnSave');
        setAllFieldsReadOnly(false);
        unhideAllRows();
        $('#set_process_date').css('visibility', 'hidden');
        $('#divCheck_process_type').css('display', 'block');
        $('#check_process_date').css('display', 'none');

        switch (Opt) {
            case 'add':
                $('#lb_fun').text('委對單 - 新增');
                saveButton.val("確定送出");
                hideFields(['tr_check_process_num', 'tr_check_process_type', 'tr_check_process_note', 'tr_close_type']);
                break;

            case 'Upd':
                $('#lb_fun').text('委對單 - 修改');
                saveButton.val("確定修改");
                $('#divCheck_process_type').css('display', 'none');
                $('#check_process_date').css('display', 'block');
                setFieldsReadOnly(['check_process_name', 'check_process_note']);
                $('#check_process_note').css('display', 'none');
                $('#set_process_date').css('visibility', 'visible');
                break;

            case 'check_process_name':
                $('#lb_fun').text('委對單 - 分配對保人員');
                saveButton.val("確定分配");
                setAllFieldsReadOnly(true);
                setFieldsReadOnly(['check_process_num', 'check_process_name', 'btnSave'], false);
                $('#btCheck_leader_num').prop('disabled', true);
                $('#btCheck_process_num').prop('disabled', false);
                hideFields(['tr_check_process_type', 'tr_check_process_note', 'tr_close_type']);
                break;

            case 'check_process_type':
                $('#lb_fun').text('委對單 - 對保人員處理');
                saveButton.val("更新進度");
                setAllFieldsReadOnly(true);
                setFieldsReadOnly(['check_process_type', 'check_process_note', 'btnSave'], false);
                $('#divCheck_process_type').css('display', 'block');
                $('#check_process_date').css('display', 'none');
                $('#lbCheck_process_note').css('visibility', 'hidden');
                hideFields(['tr_close_type']);
                break;
        }
    }

    function hideFields(rowIds) {
        rowIds.forEach(id => $(`#${id}`).css('display', 'none'));
    }

    function unhideAllRows() {
        $('tr[id]').css('display', '');
    }

    function setFieldsReadOnly(names, readOnly = true) {
        names.forEach(name => {
            $(`[name="${name}"]`).prop('readonly', readOnly).prop('disabled', readOnly);
        });
    }

    function setAllFieldsReadOnly(readOnly = true) {
        $('input, textarea, select, button').each(function() {
            if (this.id !== 'btnSave') {
                $(this).prop('readonly', readOnly).prop('disabled', readOnly);
                if (readOnly && this.tagName.toLowerCase() === 'textarea') {
                    $(this).css('background-color', '#EFEFEF4D');
                } else if (this.tagName.toLowerCase() === 'textarea') {
                    $(this).css('background-color', '');
                }
            }
        });
    }
</script>