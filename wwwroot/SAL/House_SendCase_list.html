<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="../Base.js"></script>
    <link href="../_include/main.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>作業平台</title>
</head>
<body>
    <style type="text/css">
        #gridContainer {
            width: 100%;
            height: 75vh;
            overflow: auto;
            border: 1px solid #999;
        }

        #MainTable {
            border-collapse: collapse;
            width: 1100px;
            table-layout: fixed;
            border-spacing: 0;
        }

            #MainTable th, #MainTable td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: center;
                background-color: #fff;
                white-space: normal;
                word-break: break-word;
            }

            #MainTable thead th {
                background-color: #CCCCFF;
                font-weight: bold;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            #MainTable tfoot td {
                background-color: #CCCCFF;
                font-weight: bold;
                position: sticky;
                bottom: 0;
                z-index: 10;
            }

        .frozen-col {
            position: sticky;
            z-index: 5;
        }

        #MainTable thead .frozen-col {
            background-color: #CCCCFF;
            z-index: 20;
        }

        #MainTable tbody .frozen-col {
            background-color: #FFFFFF;
        }

        #MainTable tbody tr:hover .frozen-col {
            background-color: #FCFCC0;
        }

        #MainTable tfoot .frozen-col {
            background-color: #CCCCFF;
            z-index: 15;
        }

        .col-1 {
            left: 0px;
        }

        .col-2 {
            left: 55px;
        }

        .col-3 {
            left: 143px;
        }

        .col-4 {
            left: 253px;
        }

        .col-5 {
            left: 363px;
            border-right: 2px solid #999;
        }

        td.Red {
            font-weight: bold;
            background: #FFD2D2;
        }

        #MainTable tr.Cancel td {
            text-decoration: line-through;
            color: #888 !important;
            background-color: #f0f0f0 !important;
        }

        #MainTable tbody tr.Cancel:hover .frozen-col,
        #MainTable tbody tr.Cancel:hover td {
            background-color: #e0e0e0 !important;
        }
    </style>

    <div style="width: 98%; margin: auto;">
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tbody>
                <tr>
                    <td width="20">　</td>
                    <td width="230" height="24" background="../../image/title-bk.gif">
                        <span class="c14k"><strong>撥款及費用確認書</strong></span>
                    </td>
                    <td width="770"></td>
                </tr>
                <tr class="c12-k">
                    <td></td>
                    <td colspan="2">
                        <form id="queryForm">
                            申請人：
                            <input type="text" name="CS_name" size="10" maxlength="10" value="">

                            <span id="filter-group-bc">
                                <label> 區：</label>
                                <select name="U_BC" id="U_BC"></select>
                            </span>

                            <span id="filter-group-plan">
                                <label> 業務：</label>
                                <input type="hidden" name="plan_num" id="U_num" value="">
                                <input type="text" name="plan_name" id="U_name" size="10" maxlength="10" class="box" value="" readonly>
                                <input type="button" value="..." name="_select_user_one" onclick="selectUserOne()">
                            </span>

                            撥款年月：
                            <select name="selYear_S" id="selYear_S"></select>

                            <span id="filter-group-orderby">
                                <label> 排序：</label>
                                <select name="OrderByStr" id="OrderByStr">
                                    <option value="M.U_BC,M.U_name" selected>區-業務</option>
                                    <option value="get_amount_date">撥款日期</option>
                                </select>
                            </span>
                            &nbsp;
                            <input type="button" value="查詢" onclick="fetchData();" />
                            <input type="button" value="匯出Excel" name="btnExcel" onclick="exportToExcel()">
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>

        <div id="gridContainer">
            <table id="MainTable">
                <thead>
                    <tr align="center" style="height:43px" class="c12-k">
                        <th width="5%">No.</th>
                        <th width="8%">區</th>
                        <th width="10%">進件日</th>
                        <th width="10%">申請人</th>
                        <th width="18%">介紹人</th>
                        <th width="7%">業務</th>
                        <th width="10%">撥款日</th>
                        <th width="10%">撥款金額(萬)</th>
                        <th width="10%">承作利率(%)</th>
                        <th width="12%">上傳</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const Params = getQueryParams();
        let WebUser = Params.WebUser;
        let UserProfile = {};
        let data = [];

        window.onload = function () {
            loadItemDropdown({ selectId: "U_BC", itemCode: "branch_company" });
            loadYearDown();
        };

        function loadYearDown() {
            const url = `${BASE_URL}/AE_SAL/House_SendCase_GYMQuery`;
            fetch(url)
                .then(response => response.json())
                .then(apiData => {
                    const selectElement = document.getElementById('selYear_S');
                    if (apiData.resultCode === "000") {
                        const options = JSON.parse(apiData.objResult);
                        options.forEach((option, index) => {
                            const opt = new Option(option.t, option.v);
                            if (index === 0) opt.selected = true;
                            selectElement.add(opt);
                        });
                    }
                    fetchUserProfile();
                })
                .catch(error => {
                    console.error('撥款年月載入失敗:', error);
                    alert('撥款年月載入失敗: ' + error.message);
                    fetchUserProfile();
                });
        }

        function fetchUserProfile() {
            if (!WebUser) return;
            const url = `${BASE_URL}/AE_SAL/GetUserProfile?userNum=${WebUser}`;
            fetch(url)
                .then(response => response.json())
                .then(response => {
                    if (response.resultCode === '000') {
                        const profileData = JSON.parse(response.objResult)[0];
                        UserProfile = {
                            num: profileData.U_num,
                            role: profileData.Role_num,
                            bc: profileData.U_BC
                        };
                        configureUIForRole();
                        fetchData();
                    } else {
                         throw new Error(response.resultMsg || '無法獲取使用者資料');
                    }
                })
                .catch(error => {
                    console.error('獲取使用者設定檔失敗:', error);
                    alert('獲取使用者設定檔失敗: ' + error.message);
                });
        }

        function configureUIForRole() {
            const adminRoles = ["1001", "1002", "1004", "1007"];
            const managerRoles = ["1008", "1014"];
            const assistantRoles = ["1010", "1011"];

            const bcGroup = $('#filter-group-bc');
            const planGroup = $('#filter-group-plan');
            const orderByGroup = $('#filter-group-orderby');

            bcGroup.hide();
            planGroup.hide();
            orderByGroup.hide();

            if (adminRoles.includes(UserProfile.role)) {
                bcGroup.show();
                planGroup.show();
                orderByGroup.show();
            } else if (managerRoles.includes(UserProfile.role)) {
                bcGroup.show();
                $('#U_BC').val(UserProfile.bc).prop('disabled', true);
                planGroup.show();
            } else if (assistantRoles.includes(UserProfile.role)) {
                bcGroup.show();
                $('#U_BC').val(UserProfile.bc).prop('disabled', true);
            }
        }

        function selectUserOne() {
            const managerRoles = ["1008", "1014"];
            let u_bc = $('#U_BC').is(':disabled') ? UserProfile.bc : $('#U_BC').val();
            let lock_bc = (managerRoles.includes(UserProfile.role)) ? 'Y' : 'N';
            openUserOne('appUser', u_bc, lock_bc);
        }

        function fetchData() {
            let Req = {
                CS_name: $('input[name="CS_name"]').val() || '',
                BC_code: $('select[name="U_BC"]').val(),
                plan_name: $('input[name="plan_name"]').val() || '',
                selYear_S: $('#selYear_S').val(),
                OrderByStr: $('#OrderByStr').val(),
                UserNum: UserProfile.num,
                UserRole: UserProfile.role,
                UserBC: UserProfile.bc
            };

            const url = `${BASE_URL}/AE_SAL/House_SendCase_LQuery`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Req)
            })
            .then(response => {
                 if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                }
                return response.json();
            })
            .then(responseData => {
                if (responseData.resultCode == "000") {
                    data = JSON.parse(responseData.objResult);
                    showPage(data);
                } else {
                    alert(responseData.resultMsg);
                    showPage([]);
                }
            })
            .catch(error => {
                console.error('API 請求失敗:', error);
                alert('API 請求失敗: ' + error.message);
                showPage([]);
            });
        }

        function showPage(pageData) {
                const table = document.getElementById('MainTable');
                const tbody = table.querySelector('tbody');
                const tfoot = table.querySelector('tfoot');
                tbody.innerHTML = '';
                tfoot.innerHTML = '';

                let sumAmount = 0;

                pageData.forEach((item, index) => {
                    const row = tbody.insertRow();
                    row.align = 'center';
                    row.className = 'c12-k';
                    row.style.backgroundColor = '#FFFFFF';
                    row.onmouseover = () => { if (!row.classList.contains('Cancel')) row.style.backgroundColor = '#FCFCC0'; };
                    row.onmouseout = () => { if (!row.classList.contains('Cancel')) row.style.backgroundColor = '#FFFFFF'; };

                    if (item.isCancel === 'Y') {
                        row.classList.add('Cancel');
                    }

                    sumAmount += (item.isCancel !== 'Y' ? parseFloat(item.get_amount || 0) : 0);

                    if (item.I_Count > 1 && !item.Introducer_PID) {
                        row.classList.add('Red');
                    }

                    const cells = [
                        index + 1,
                        item.U_BC_name || '',
                        item.Send_amount_date || '',
                        item.CS_name || '',
                        item.CS_introducer || '',
                        item.plan_name || '',
                        item.get_amount_date || '',
                        parseFloat(item.get_amount || 0).toLocaleString(),
                        item.interest_rate_pass || '',
                        `<input type="button" class="${(item.upLoad_Count > 0 ? 'btn_red_1' : 'btn')}"
                               value="附加檔案 (${item.upLoad_Count})"
                               onclick="window.open('../File/File_UpLoad_List.html?cknum=${item.File_ID}&user=${encryptParameter(WebUser)}', '_file_list', 'scrollbars=yes,resizable=no,width=725,height=400,top=300,left=150');">`
                    ];

                    cells.forEach(cellHTML => {
                        const cell = row.insertCell();
                        cell.innerHTML = cellHTML;
                    });
                });

                const footerRow = tfoot.insertRow();
                footerRow.className = 'foot';
                footerRow.align = 'center';

                footerRow.innerHTML = `
                    <td colspan="4"><font color="#000080"><label id="CountRows">筆數: ${pageData.length}</label></font></td>
                    <td colspan="3" style="text-align:right;"><font color="#000080">合計:</font></td>
                    <td><font color="#000080">${sumAmount.toLocaleString()}</font></td>
                    <td colspan="2"></td>
                `;

                applyStickyStyles();
            }

        function applyStickyStyles() {
            $('#MainTable .frozen-col').removeClass('frozen-col col-1 col-2 col-3 col-4 col-5');
            $('#MainTable thead tr, #MainTable tbody tr, #MainTable tfoot tr').each(function() {
                $(this).find('th:lt(5), td:lt(5)').each(function(index) {
                    $(this).addClass('frozen-col col-' + (index + 1));
                });
            });
        }

        function getFormattedDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function exportToExcel() {
            if (!data || data.length === 0) {
                alert("沒有可匯出的資料。");
                return;
            }

            const headers = [
                "No.", "區", "進件日", "申請人", "介紹人", "業務", "撥款日", "撥款金額(萬)", "承作利率(%)"
            ];

            const dataForExport = data.map((item, index) => [
                index + 1,
                item.U_BC_name || '',
                item.Send_amount_date || '',
                item.CS_name || '',
                item.CS_introducer || '',
                item.plan_name || '',
                item.get_amount_date || '',
                parseFloat(item.get_amount || 0),
                item.interest_rate_pass || ''
            ]);

            const totalAmount = data.reduce((sum, item) =>
                sum + (item.isCancel !== 'Y' ? parseFloat(item.get_amount || 0) : 0), 0);

            const footerRow = [
                `筆數: ${data.length}`, null, null, null, null, null, '合計:', totalAmount, null
            ];

            const sheetData = [headers, ...dataForExport, footerRow];
            const ws = XLSX.utils.aoa_to_sheet(sheetData);

            ws['!cols'] = [
                { wch: 5 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 20 },
                { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
            ];

            const currencyFormat = '#,##0';
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 1; R <= range.e.r; ++R) {
                const cell_ref = XLSX.utils.encode_cell({ c: 7, r: R });
                if (ws[cell_ref] && ws[cell_ref].v !== null) {
                    ws[cell_ref].z = currencyFormat;
                }
            }

            ws['!merges'] = [{ s: { r: data.length + 1, c: 0 }, e: { r: data.length + 1, c: 5 } }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '撥款及費用確認書');
            const filename = `撥款及費用確認書-${getFormattedDate()}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>