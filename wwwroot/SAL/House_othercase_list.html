<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="../tool_js/jquery.table2excel.js"></script>
    <link href="../_include/main.css" rel="stylesheet" type="text/css">
    <script src="../Base.js"></script>
    <title>作業平台</title>
</head>
<body>
    <table border="0" width="100%">
        <tbody>
            <tr>
                <td width="20">　</td>
                <td width="230" height="24" background="../../image/title-bk.gif">
                    <span class="c14k"><strong>車貸建檔</strong></span>
                </td>
                <td width="770"></td>
            </tr>
            <tr class="c12-k">
                <td></td>
                <td colspan="2">
                    <table border="0" with="100%" id="table1">
                        <tr class="c12-k">
                            <td colspan="4" align="left" width="80%">
                                區：
                                <select name="U_BC" id="U_BC" class=""></select>
                                撥款年月：
                                <select name="selYear_S" id="selYear_S"></select>
                            </td>
                        </tr>
                        <tr class="c12-k">
                            <td>
                                <input type="button" value="查詢" onclick="fetchData();" />  &nbsp;
                                <input type="button" value="匯出Excel" name="btnExcel" onclick="exportToExcel()">
                            </td>
                            <td>
                                <input type="button" name="add" value="新增案件" onclick="addHouse_othercase();">
                            </td>
                        </tr>
                    </table>
                    
                </td>
            </tr>
            
        </tbody>
    </table>
    
    <table width="1050" border="0" cellspacing="0" cellpadding="0">
        <tbody>
            <tr>
                <td valign="top"> </td>
                <td align="center" valign="top">
                    <table id="MainTable" width="1150" border="0" cellpadding="4" cellspacing="1" bgcolor="#666666">
                        <thead>
                            <tr align="center" bgcolor="#CCCCFF" class="c12-k">
                                <td width="50">序號</td>
                                <td width="100">放款公司</td>
                                <td width="100">專案名稱</td>
                                <td width="80">客戶</td>
                                <td width="80">客戶ID</td>
                                <td width="120">撥款金額(萬)</td>
                                <td width="60">期數</td>
                                <td width="60">承作利率</td>
                                <td width="100">撥款日期</td>
                                <td width="60">佣金</td>
                                <td width="60">經辦業務</td>
                                <td width="60">備註</td>
                                <td width="60">核准函</td>
                                <td width="30">修改</td>
                                <td width="30">刪除</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr align="center" class="c12-k" bgcolor="#FFFFFF" onmouseover="this.style.background='#FFFF66';" onmouseout="this.style.background='#FFFFFF'; " style="background: rgb(255, 255, 255);">
                            </tr>
                            <tr align="center" class="c12-k" bgcolor="#FFFFFF" onmouseover="this.style.background='#FFFF66';" onmouseout="this.style.background='#FFFFFF'; " style="background: rgb(255, 255, 255);">
                            </tr>
                            <tr align="center" height="30" bgcolor="#CCCCFF">
                                <td class="c12-k" colspan="16">
                                    
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr align="center" height="15" bgcolor="#CCCCFF">
                                <td class="c12-k" colspan="15">
                                    <font color="#000080">
                                        <label id="CountRows"></label>
                                    </font>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="pagination"></div>
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
<script>
    const Params = getQueryParams();
    let WebUser = Params.WebUser;
    let UserProfile = {};

    const itemsPerPage = 20;  
    let currentPage = 1;
    let data = []; 

    $(document).ready(function() {
        console.log("Document ready. Starting initial load...");
        loadItemDropdown({ selectId: "U_BC", itemCode: "branch_company" });
        loadYearDown();
    });

    function loadYearDown() {
        console.log("Step 1: Starting loadYearDown...");
        const url = `${BASE_URL}/AE_SAL/House_othercase_GYMQuery`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.resultCode === "000") {
                    console.log("Step 1: Successfully loaded year/month dropdown.");
                    const selectElement = document.getElementById('selYear_S');
                    const options = JSON.parse(data.objResult);
                    options.forEach((option, index) => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.v; 
                        optionElement.textContent = option.t;
                        if (index === 0) {
                            optionElement.selected = true;
                        }
                        selectElement.appendChild(optionElement);
                    });
                    // After setting up years, get user profile.
                    fetchUserProfile();
                } else {
                    console.error("Step 1 Failed: Could not load year/month data.", data.resultMsg);
                    alert('無法載入撥款年月資料: ' + data.resultMsg);
                }
            })
            .catch(error => {
                console.error("Step 1 Failed: API request for year/month failed.", error);
                alert('無法載入撥款年月資料，請稍後再試。');
            });
    }

    function fetchUserProfile() {
        console.log("Step 2: Starting fetchUserProfile...");
        if (!WebUser) {
            console.error("Step 2 Failed: WebUser is not defined.");
            alert('無法識別使用者');
            return;
        }
        const url = `${BASE_URL}/AE_SAL/GetUserProfile?userNum=${WebUser}`;
        fetch(url)
            .then(response => response.json())
            .then(response => {
                if (response.resultCode === '000') {
                    console.log("Step 2: Successfully fetched user profile.");
                    const profileData = JSON.parse(response.objResult)[0];
                    UserProfile = {
                        num: profileData.U_num,
                        role: profileData.Role_num,
                        bc: profileData.U_BC
                    };
                    configureUIForRole();
                    fetchData(); // Initial data fetch after getting profile and setting UI.
                } else {
                    console.error("Step 2 Failed: Could not fetch user profile.", response.resultMsg);
                    alert('無法獲取使用者資訊: ' + response.resultMsg);
                }
            })
            .catch(error => {
                console.error("Step 2 Failed: API request for user profile failed.", error);
                alert('獲取使用者資訊失敗，請稍後再試。');
            });
    }
    
    function configureUIForRole() {
        console.log("Configuring UI for role:", UserProfile.role);
        const adminRoles = ["1001", "1004", "1006", "1007"];
        const bcDropdown = document.getElementById('U_BC');
        const bcLabel = document.getElementById('U_BC_Label');

        if (adminRoles.includes(UserProfile.role)) {
            bcDropdown.disabled = false;
        } else if (UserProfile.role === "1008" || UserProfile.role === "1010") {
            bcDropdown.value = UserProfile.bc;
            bcDropdown.disabled = true;
        } else {
            bcDropdown.style.display = 'none';
            bcLabel.style.display = 'none';
        }
    }

    function fetchData() {
        console.log("Step 3: Starting fetchData...");
        if (!UserProfile.num) {
            console.warn("Step 3 Aborted: User profile not loaded yet.");
            return;
        }

        const Req = {
            BC_code: document.querySelector('#U_BC').value,
            selYear_S: document.getElementById('selYear_S').value,
            UserNum: UserProfile.num,
            UserRole: UserProfile.role,
            UserBC: UserProfile.bc
        };
        
        console.log("Step 3: Sending request to House_othercase_LQuery with payload:", Req);
        const url = `${BASE_URL}/AE_SAL/House_othercase_LQuery`;
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(Req)
        })
        .then(response => response.json())
        .then(responseData => {
            if (responseData.resultCode == "000") {
                console.log("Step 3: Successfully received data from House_othercase_LQuery.");
                const response = JSON.parse(responseData.objResult);
                data = response.Data;
                const isPeriodClosed = response.IsPeriodClosed;
                showPage(currentPage, isPeriodClosed);
                createPagination();
            } else {
                console.error("Step 3 Failed: API returned an error.", responseData.resultMsg);
                alert(responseData.resultMsg);
                document.querySelector('#MainTable tbody').innerHTML = '';
                document.getElementById('CountRows').innerHTML = `筆數: 0`;
            }
        })
        .catch(error => {
            console.error("Step 3 Failed: API request to House_othercase_LQuery failed.", error);
            alert('API 請求失敗:', error);
        });
    }

    function showPage(page, isPeriodClosed) {
        // This function remains the same as the previous version
        document.getElementById('CountRows').innerHTML = `筆數:${data.length}`;
        const tbody = document.querySelector('#MainTable tbody');
        tbody.innerHTML = '';

        const startIndex = (page - 1) * itemsPerPage;
        const pageData = data.slice(startIndex, startIndex + itemsPerPage);

        for (let i = 0; i < pageData.length; i++) {
            const item = pageData[i];
            const row = document.createElement('tr');
            row.align = 'center';
            row.className = 'c12-k';
            row.style.backgroundColor = '#FFFFFF';
            row.onmouseover = function() { this.style.backgroundColor = '#FCFCC0'; };
            row.onmouseout = function() { this.style.backgroundColor = '#FFFFFF'; };

            // 將從 API 取得的西元日期轉換為國曆日期 
            const rocDate = item.get_amount_date ? convertToROCDate(item.get_amount_date) : '';

            row.innerHTML = `
                <td>${startIndex + i + 1}</td>
                <td>${item.show_fund_company || ''}</td>
                <td>${item.show_project_title || ''}</td>
                <td>${item.cs_name || ''}</td>
                <td>${item.cs_id || ''}</td>
                <td>${item.get_amount || ''}</td>
                <td>${item.period || ''}</td>
                <td>${item.interest_rate_pass ? item.interest_rate_pass + '%' : ''}</td>
                <td>${rocDate || ''}</td>
                <td>${item.comm_amt || 0}</td>
                <td>${item.plan_name || ''}</td>
                <td>${item.case_remark || ''}</td>
            `;

            const attachmentCell = document.createElement('td');
            const button = document.createElement('input');
            button.type = 'button';
            button.value = `附加檔案(${item.case_id_count || 0})`;
            button.onclick = () => window.open(`../File/File_UpLoad_List.html?cknum=${item.case_id}&user=${encryptParameter(WebUser)}`, '_blank', 'scrollbars=yes,resizable=yes,top=100,width=800,height=500');
            attachmentCell.appendChild(button);
            row.appendChild(attachmentCell);

            let encryptedId = encryptParameter(item.case_id);
            let encryptedWebUser = encryptParameter(WebUser);
            row.appendChild(createButtonCell("../images/edit.png", "修改", () => window.open(`House_othercase_Detail.html?Id=${encryptedId}&User=${encryptedWebUser}`, '_blank', 'scrollbars=yes,resizable=yes,top=100,width=800,height=500')));
            
            const canDelete = !isPeriodClosed && !item.confirm_num;
            if (canDelete) {
                row.appendChild(createButtonCell("../images/delete.png", "刪除", () => {
                    if (confirm('確定要刪除此筆資料嗎?')) {
                        deleteCase(item.case_id);
                    }
                }));
            } else {
                row.insertCell(-1);
            }
            tbody.appendChild(row);
        }
    }

    function deleteCase(caseId) {
        const url = `${BASE_URL}/AE_SAL/House_othercase_Del?Id=${caseId}`;
        fetch(url, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(responseData => {
            if (responseData.resultCode === '000') {
                alert('已刪除');
                fetchData();
            } else {
                alert('刪除失敗: ' + responseData.resultMsg);
            }
        })
        .catch(error => alert('刪除請求失敗，請洽資訊人員。'));
    }

    function addHouse_othercase() {
        let encryptedId = encryptParameter('add');
        let encryptedWebUser = encryptParameter(WebUser);
        window.open(`House_othercase_Detail.html?Id=${encryptedId}&User=${encryptedWebUser}`, '_blank', 'scrollbars=yes,resizable=yes,top=100,width=800,height=500');
    }
    function exportToExcel() {
        // 1. 獲取原始表格
        var table = document.getElementById('MainTable');
        if (!table) {
            alert('錯誤：找不到識別碼為 MainTable 的表格。');
            return;
        }

        // 2. 深度複製一份表格以進行操作
        var clonedTable = table.cloneNode(true);

        // 3. 移除複製後表格的最後一行 (此為顯示筆數的頁尾)
        if (clonedTable.rows.length > 0) {
            clonedTable.deleteRow(clonedTable.rows.length - 1);
        }

        // 4. 遍歷所有剩下的資料行 (包含標題列)，並移除最後兩個欄位
        for (var i = 0; i < clonedTable.rows.length; i++) {
            var row = clonedTable.rows[i];
            // 進行安全檢查，確保該行有足夠的儲存格
            if (row.cells.length >= 15) {
                // 從後面開始刪除，避免索引錯亂
                // 刪除 "刪除" 欄位 (原索引 14)
                row.deleteCell(14);
                // 刪除 "修改" 欄位 (原索引 13)
                row.deleteCell(13);
            }
        }

        // 5. 將整理好的表格暫時附加到頁面並隱藏，以供套件讀取
        $(clonedTable).attr('id', 'tbExcelForExport'); // 使用唯一的ID避免衝突
        $('body').append(clonedTable);
        $(clonedTable).hide();

        // 6. 使用 table2excel 套件產生並下載 Excel 檔案
        var fileNa = getCurrentDateTime();
        $("#tbExcelForExport").table2excel({
            exclude: ".noExl",
            name: "Worksheet",
            filename: "車貸建檔-" + fileNa,
            fileext: ".xls"
        });

        // 7. 從頁面中移除暫時的表格
        $("#tbExcelForExport").remove();
    }
    function getCurrentDateTime() {
      var currentDate = new Date();
      var year = currentDate.getFullYear();
      var month = ('0' + (currentDate.getMonth() + 1)).slice(-2);
      var day = ('0' + currentDate.getDate()).slice(-2);
      var hours = ('0' + currentDate.getHours()).slice(-2);
      var minutes = ('0' + currentDate.getMinutes()).slice(-2);
      var formattedDateTime = year + month + day + hours + minutes;
      return formattedDateTime;
    }
    function createCountRows()
    {
        const tbody = document.querySelector('#MainTable tbody');
        tbody.innerHTML = '';
        const row = document.createElement('tr');
            row.setAttribute('align', 'center');
            row.setAttribute('class', 'c12-k');
            row.setAttribute('bgcolor', '#FFFFFF');
            row.setAttribute('onmouseover', "this.style.background='#FCFCC0';");
            row.setAttribute('onmouseout', "this.style.background='#FFFFFF';");

        const serialCell = document.createElement('td');
            serialCell.textContent = '筆數: 0';
            row.appendChild(serialCell);
    }

</script>