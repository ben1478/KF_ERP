<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="../Base.js"></script>
    <title>作業平台</title>
</head>
<body>
    <table width="1200" border="0" cellspacing="0" cellpadding="0">
        <tbody>
            <tr>
                <td width="40"> </td>
                <td height="24"colspan="2">
                    <span class="c14k"><strong>使用者管理</strong></span>
                </td>
            </tr>
            <tr>
                <td width="40"> </td>
                <td colspan="2">
                    <input type="button" value="下載emp.json" onclick="GetUserJson();"/>
                </td>
            </tr>
            <tr>
                <td width="40"> </td>
                <td width="1000">
                    <span id="ID104_wrapper">
                        ID104：
                        <select name="ID104" id="ID104" style="width:80px">
                            <option value="">ALL</option>
                            <option value="Y">有</option>
                            <option value="N">沒有</option>
                        </select>
                    </span>
                    <span>員編／姓名：<input type="text" name="queryword" size="10" value="" class="c12-k"></span>
                    <span>(模糊比對)  公司別：<select name="U_BC" id="U_BC" class=""></select></span>&nbsp;&nbsp;
                    <span>
                        在職狀態：
                        <select name="job_status" id="job_status" style="width:80px">
                            <option value="">請選擇</option>
                            <option value="Y">在職</option>
                            <option value="N">離職</option>
                        </select>
                    </span>
                    &nbsp;&nbsp;
                    <span>角色名稱：<select name="role" id="role" style="width:80px"></select></span>
                    <input type="button" name="query" class="" value="查詢" onclick="fetchData();">
                <td width="160"  align="right">
                    <input type="button" name="add" value="新增使用者" onclick="addUser(); ">
                </td>
            </tr>
        </tbody>
    </table>

    <table width="1300" border="0" cellspacing="0" cellpadding="0">
        <tbody>
            <tr>
                <td valign="top">　</td>
                <td align="center" valign="top">
                    <table id="MainTable" width="1300" border="0" cellpadding="4" cellspacing="1" bgcolor="#666666" style="font-size:14px;">
                        <thead>
                            <tr align="center" bgcolor="#CCCCFF" class="c12-k">
                                <td width="50">序號</td>
                                <td id="ID104_row" width="60">ID_104</td>
                                <td width="80">公司別</td>
                                <td width="120">職稱</td>
                                <td width="80">角色</td>
                                <td width="60">員編</td>
                                <td width="100">姓名</td>
                                <td width="60">代理人</td>
                                <td width="60">直屬主管</td>
                                <td width="60">單位主管</td>
                                <td width="60">是否在職</td>
                                <td width="60">夾檔管理</td>
                                <td width="30">修改</td>
                                <td width="50">密碼<br>變更</td>
                                <td width="50">年假<br>管理</td>
                                <td width="50">人事<br>異動</td>
                                <td width="300">可查看公司</td>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="pagination"></div>
                </td>
            </tr>
        </tbody>
    </table>
</body>

</html>
<script>
    const Params = getQueryParams();
    let WebUser = Params.WebUser;
    let WebBC = Params.WebBC;

    const itemsPerPage = 20;  
    let currentPage = 1;  
    let data = [];  

    loadItemDropdown({
        selectId: "U_BC",
        itemCode: "branch_company"
    });
    loadRolmDropdown();
    fetchData();

    if (WebUser === 'AA999') {
        document.getElementById('ID104_wrapper').style.display = '';
        document.getElementById('ID104_row').style.display = '';
    } else {
        document.getElementById('ID104_wrapper').style.display = 'none';
        document.getElementById('ID104_row').style.display = 'none';
    }

    function fetchData() {
        const requestData = {
            U_Num_Name: document.querySelector('input[name="queryword"]').value,
            U_BC: document.querySelector('select[name="U_BC"]').value,
            Job_Status: document.querySelector('select[name="job_status"]').value,
            U_Role: document.querySelector('select[name="role"]').value,
            ID_104: document.querySelector('select[name="ID104"]').value
        };

        const url = `${BASE_URL}/AE_HR/User_M_LQuery`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
            credentials: 'include'
        })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.resultCode == "000") {
                    data = JSON.parse(responseData.objResult);  // 儲存資料
                    showPage(currentPage);  // 顯示初始頁面
                    createPagination();  // 創建分頁
                } else {
                    console.error('API 回傳資料格式錯誤');
                }
            })
            .catch(error => {
                console.error('API 請求失敗:', error);
            });
    }

    function showPage(page) {
        const tbody = document.querySelector('#MainTable tbody');
        tbody.innerHTML = '';

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, data.length);
        const pageData = data.slice(startIndex, endIndex);  // 當前頁面的資料

        pageData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.setAttribute('align', 'center');
            row.setAttribute('class', 'c12-k');
            row.setAttribute('bgcolor', '#FFFFFF');
            row.setAttribute('onmouseover', "this.style.background='#FCFCC0';");
            row.setAttribute('onmouseout', "this.style.background='#FFFFFF';");

            const serialCell = document.createElement('td');
            serialCell.textContent = startIndex + index + 1;  // 序號
            row.appendChild(serialCell);

            const keys = Object.keys(item);
            keys.forEach(key => {
                const cell = document.createElement('td');
                if (key === 'cknum') {
                    const button = document.createElement('input');
                    button.type = 'button';
                    button.value = '夾檔管理';
                    button.onclick = function () {
                        window.open(`../File/File_UpLoad_List.html?cknum=${item[key]}&User=${WebUser}`, '_blank', 'scrollbars=yes,resizable=yes,top=100,width=800,height=500');
                    };
                    cell.style.textAlign = 'center';
                    cell.style.verticalAlign = 'middle';
                    cell.appendChild(button);
                    row.appendChild(cell);
                    row.appendChild(createButtonCell(
                        "../images/edit.png",
                        "修改",
                        function () {
                            window.open(`../HR/User_edit.html?U_num=${encryptParameter(item.U_num)}&User=${encryptParameter(WebUser)}`, '_blank', 'scrollbars=yes,resizable=yes,top=100,width=800,height=500');
                        }
                    ));
                    row.appendChild(createButtonCell(
                        "../images/edit.png",
                        "密碼變更",
                        function () {
                            window.open(`../HR/EditPsw.html?U_num=${encryptParameter(item.U_num)}&User=${encryptParameter(WebUser)}`, '_blank', 'scrollbars=yes,resizable=yes,top=100,width=500,height=300');
                        }
                    ));
                    row.appendChild(createButtonCell(
                        "../images/edit.png",
                        "年假異動",
                        function () {
                            window.open(`../HR/Hday.html?U_num=${encryptParameter(item.U_num)}&User=${encryptParameter(WebUser)}`, '_blank', 'scrollbars=yes,resizable=yes,top=50,width=1200,height=500');
                        }
                    ));
                    row.appendChild(createButtonCell(
                        "../images/edit.png",
                        "人事異動",
                        function () {
                            window.open(`../HR/UserAppForm.html?U_num=${item.U_num}`, '_blank', 'scrollbars=yes,resizable=yes,top=50,width=900,height=600');
                        }
                    ));
                } else {
                    if (WebUser === 'AA999' && key === 'ID_104') {
                        if (item[key] === null || item[key] === '') {
                            cell.innerHTML = `<a href="#" onclick="GetSignIn_104('${item.U_num}')">取得ID_104</a>`;
                        } else {
                            cell.textContent = item[key];
                        }
                        row.appendChild(cell);
                    } else if (key !== 'ID_104') {
                        cell.textContent = item[key];
                        row.appendChild(cell);
                    }
                }
            });
            tbody.appendChild(row);
        });
    }

    function GetUserJson() {
        const url = `${BASE_URL}/AE_HR/GetEmpJson`;
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('伺服器錯誤，狀態碼：' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: "application/json" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'emp.json';
                link.click();
                URL.revokeObjectURL(link.href);
            })
            .catch(error => {
                console.error('取得資料時發生錯誤：', error);
            });
    }

    function addUser() {
        window.open(`../HR/User_add.html?User=${encryptParameter(WebUser)}`, 'add', 'scrollbars=yes,resizable=yes,width=800,height=500,left=250,top=100');
    }

    function GetSignIn_104(p_u_num) {
        var Param =
        {
            "USER_ACCOUNT": "KF_ERP",
            "USER_PWD": "Kf52611690"
        };
        $.ajax({
            url: "http://192.168.1.239:3001/api/auth/signIn",
            type: 'POST',
            data: JSON.stringify(Param),
            contentType: 'application/json',
            async: false,
            success: function (response) {
                if (response.code == "200") {
                    var ACCESS_TOKEN = response.data.ACCESS_TOKEN;
                    GetID_104(ACCESS_TOKEN, p_u_num)
                }
                else {
                    alert("GetSignIn_104轉入失敗,請聯絡IT:" + response.msg)
                }
            },
            error: function (xhr, status, error) {
                alert("Call104_singleLeave轉入失敗,請聯絡IT")
                Result = false;
            }
        });
    }

    function GetID_104(ACCESS_TOKEN, p_u_num) {
        var Param =
        {
            "CO_CODE": "52611690",
            "EMP_NO": p_u_num
        }

        var result = {};
        result.code = "000";
        result.date = {};
        $.ajax({
            url: "http://192.168.1.239:3001/api/ed/emp_id",
            type: "POST",
            headers: { "Accept": "*/*", "Authorization": "Bearer " + ACCESS_TOKEN },
            data: JSON.stringify(Param),
            contentType: "application/json",
            async: false,
            success: function (response) {
                if (response.code == "200") {
                    if (response.data.length > 0) {
                        var EMP_ID = response.data[0].EMP_ID;
                        if ((window.confirm("ID_104:" + EMP_ID + ";是否更新??"))) {
                            $.ajax({
                                url: `${BASE_URL}/AE_HR/User_104_Upd`,
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    U_num: p_u_num,
                                    ID_104: EMP_ID
                                }),
                                async: false,
                                success: function (response) {
                                    if (response.resultCode === "000") {
                                        alert("更新成功");
                                        btnQuery.click();
                                    }
                                    else {
                                        alert("取得ID_104失敗," + response.resultMsg)
                                    }
                                },
                                error: function (xhr, status, error) {
                                    alert("Modify_ID104取得失敗,請聯絡IT")
                                }
                            });
                        }
                    }
                }
                else {
                    result.code = "999";
                    alert("GetID_104 失敗,請聯絡IT:" + response.msg)
                }
            },
            error: function (xhr, status, error) {
                alert("GetID_104 失敗," + xhr.responseJSON.msg + ",請聯絡IT")
                result.code = "999";
            }
        });
        return result
    }
</script>