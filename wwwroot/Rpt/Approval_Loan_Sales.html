<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../tool_js/jquery.blockUI.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link href="../_include/main.css" rel="stylesheet" type="text/css">
    <script src="../Base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <title>作業平台</title>
    <style type="text/css">
        /* 強制修正盒模型，確保不受任何外部 CSS 檔案干擾 */
        #gridContainer *, #gridContainer *::before, #gridContainer *::after {
            box-sizing: border-box !important;
        }

        /* 基本樣式 */
        body {
            font-family: Arial, sans-serif;
            margin: 1em;
        }

        .container {
            max-width: 95%;
            margin: auto;
        }

        .filter-form {
            margin-bottom: 1em;
            display: flex;
            gap: 1em;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-bar {
            display: flex;
            gap: 20px; /* 兩個標籤之間的間距 */
            align-items: center;
            margin-bottom: 1em;
            font-size: 16px;
        }

        .status-label {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

            .status-label.unfulfilled {
                background-color: #FFD2D2; /* 未齊件的背景色 */
                color: #c00;
                font-size: 12px;
            }

            .status-label.other-fees {
                color: blue;
            }

        .other-fees-link {
            color: blue;
            cursor: pointer;
            text-decoration: underline;
        }
        /* 1.單一滾動容器 */
        #gridContainer {
            width: 100%;
            height: 80vh; /* 根據需要調整高度 */
            overflow: auto;
            border: 1px solid #999;
        }

        table {
            border-collapse: collapse;
            width: 2920px; /* 根據您的欄位寬度總和設定 */
            table-layout: fixed;
            border-spacing: 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            white-space: normal; /* 從 nowrap 改為 normal，允許自動換行 */
            word-break: break-word; /* 增加此行，可以讓過長的英文或數字強制斷行 */
            background-color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 2. 表頭 (thead) 的黏性定位 */
        thead th {
            background-color: #CCCCFF;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* 3. 【通用規則】設定所有凍結欄儲存格的水平黏性  */
        th.frozen-col,
        td.frozen-col {
            position: sticky;
            z-index: 5; /* 基本層級 */
            background-color: #f8f9fa; /* 統一給予一個淡淡的底色 */
        }

        /* 4. 左上角凍結表頭 (thead .frozen-col) 的最優先級 */
        thead th.frozen-col {
            background-color: #CCCCFF; /* 確保維持表頭的顏色 */
            z-index: 20; /* 最高的堆疊層級 */
        }

        /* 5. 凍結表尾 (tfoot .frozen-col) 的樣式 */
        tfoot td.frozen-col {
            position: sticky; /* 確保 tfoot 的凍結欄也黏住 */
            z-index: 15; /* 層級高於內容，但低於表頭 */
            background-color: #CCCCFF; /* 給予表尾一個不同的顏色 */
        }
        /* --- 欄位寬度與凍結位置設定 --- */
        th:nth-child(1), td:nth-child(1) {
            width: 50px;
        }

        th.frozen-col:nth-child(1), td.frozen-col:nth-child(1) {
            left: 0px;
        }

        th:nth-child(2), td:nth-child(2) {
            width: 100px;
        }

        th.frozen-col:nth-child(2), td.frozen-col:nth-child(2) {
            left: 50px;
        }

        th:nth-child(3), td:nth-child(3) {
            width: 110px;
        }

        th.frozen-col:nth-child(3), td.frozen-col:nth-child(3) {
            left: 150px;
        }

        th:nth-child(4), td:nth-child(4) {
            width: 100px;
        }

        th.frozen-col:nth-child(4), td.frozen-col:nth-child(4) {
            left: 260px;
        }

        /* Col 5: 介紹人 (新的凍結欄) */
        th:nth-child(5), td:nth-child(5) {
            width: 100px;
        }

        th.frozen-col:nth-child(5), td.frozen-col:nth-child(5) {
            left: 360px;
        }

        /* Col 6: ID (新的非凍結欄) */
        th:nth-child(6), td:nth-child(6) {
            width: 120px;
        }

        th:nth-child(7), td:nth-child(7) {
            width: 120px;
        }

        th:nth-child(8), td:nth-child(8) {
            width: 140px;
        }

        th:nth-child(9), td:nth-child(9) {
            width: 100px;
        }


        th:nth-child(10), td:nth-child(10) {
            width: 110px;
        }

        th:nth-child(11), td:nth-child(11) {
            width: 110px;
        }

        th:nth-child(12), td:nth-child(12) {
            width: 110px;
        }

        th:nth-child(13), td:nth-child(13) {
            width: 110px;
        }

        th:nth-child(14), td:nth-child(14) {
            width: 180px;
        }

        th:nth-child(15), td:nth-child(15) {
            width: 100px;
        }

        th:nth-child(16), td:nth-child(16) {
            width: 100px;
        }

        th:nth-child(17), td:nth-child(17) {
            width: 100px;
        }

        th:nth-child(18), td:nth-child(18) {
            width: 90px;
        }

        th:nth-child(19), td:nth-child(19) {
            width: 90px;
        }

        th:nth-child(20), td:nth-child(20) {
            width: 90px;
        }

        th:nth-child(21), td:nth-child(21) {
            width: 90px;
        }

        th:nth-child(22), td:nth-child(22) {
            width: 90px;
        }

        th:nth-child(23), td:nth-child(23) {
            width: 120px;
        }

        th:nth-child(24), td:nth-child(24) {
            width: 110px;
        }

        th:nth-child(25), td:nth-child(25) {
            width: 110px;
        }

        th:nth-child(26), td:nth-child(26) {
            width: 110px;
        }

        th:nth-child(27), td:nth-child(27) {
            width: 100px;
        }

        th:nth-child(28), td:nth-child(28) {
            width: 110px;
        }

        th:nth-child(29), td:nth-child(29) {
            width: 100px;
        }
        /* 權限控制：隱藏欄位的 CSS */
        .hide-column-23 th:nth-child(23),
        .hide-column-23 td:nth-child(23) {
            display: none;
        }

        /* 狀態顏色 */
        tr.is-cancel td {
            text-decoration: line-through;
            color: #999;
        }

        tr.is-red td {
            background-color: #FFD2D2 !important;
        }

        .log-table-container {
            max-height: 250px; /* 設定歷程區塊的最大高度，您可以依需求調整 */
            overflow-y: auto; /* 當內容超出最大高度時，顯示垂直捲動軸 */
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        /* ... 其他 CSS ... */

        /* 「預估退佣金」的超連結樣式 */
        .commission-link {
            color: red;
            text-decoration: underline;
            cursor: pointer;
        }

            .commission-link:hover {
                color: darkred;
            }

        /* 設定 BlockUI 彈出視窗的標題列樣式 */
        div.blockMsg {
            padding: 0 !important;
            border-radius: 10px; /* 確保整個容器有圓角 */
            border: 1px solid #999;
        }

        .custom-modal-title {
            background-color: #e0e0e0; /* 灰色背景 */
            color: #333;
            text-align: left;
            padding: 10px 15px;
            font-weight: bold;
            cursor: move; /* 讓滑鼠在標題列上時顯示為移動圖示 */
            border-bottom: 1px solid #ccc;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .custom-modal-content {
            padding: 15px;
            overflow-y: auto;
        }
        /* 彈出視窗內的表格樣式 */
        #RefInfo {
            width: auto; /* 讓表格寬度由內容決定，而不是強制撐滿 */
            table-layout: fixed; /* 使用固定寬度佈局，效能較好 */
            margin: auto;
            border: 1px solid #666;
        }

            #RefInfo th, #RefInfo td {
                padding: 8px;
                text-align: center;
                border: 1px solid #666;
                /* 為避免內容過長破壞版面，增加文字截斷效果 */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #RefInfo thead th {
                background-color: #CCCCFF;
            }
            /* 設定 BlockUI 彈出視窗的表格中，表尾的樣式 */
            #RefInfo tfoot tr td {
                background-color: #CCCCFF; /* 與表頭相同的顏色 */
                font-weight: bold;
            }

            #RefInfo tr.Sel td,
            div.blockMsg table#RefInfo tr.Sel td {
                font-weight: bold;
                background-color: #FFD2D2; /* 使用 !important 強制覆蓋 */
            }

            /* --- 欄位寬度調整 --- */
            /* Col 1: 專案名稱 */
            #RefInfo th:nth-child(1), #RefInfo td:nth-child(1) {
                width: 120px;
            }

            /* Col 2: 貸款成數 (加寬) */
            #RefInfo th:nth-child(2), #RefInfo td:nth-child(2) {
                width: 110px;
            }

            /* Col 3: 承作利率 (縮減) */
            #RefInfo th:nth-child(3), #RefInfo td:nth-child(3) {
                width: 80px;
            }

            /* Col 4: 佣金 (縮減) */
            #RefInfo th:nth-child(4), #RefInfo td:nth-child(4) {
                width: 80px;
            }

            /* Col 5: 參考維護人 */
            #RefInfo th:nth-child(5), #RefInfo td:nth-child(5) {
                width: 100px;
            }

            /* Col 6: 參考建立時間 (加寬) */
            #RefInfo th:nth-child(6), #RefInfo td:nth-child(6) {
                width: 160px;
            }
        /* ===== START: 修正後的表尾樣式 ===== */

        /* 5. 為凍結表尾的「儲存格」設定通用樣式 */
        tfoot td.frozen-col {
            position: sticky;
            z-index: 15;
        }

        /* 為「未齊件合計」列的所有儲存格設定樣式 */
        tfoot tr.footer-row-misaligned td {
            background-color: #CCCCFF; /* 與表頭相同的顏色 */
            font-weight: bold;
        }

        /* 為「總合計」列的所有儲存格設定樣式 */
        tfoot tr.footer-row-total td {
            background-color: #CCCCFF; /* 與表頭相同的顏色 */
            font-weight: bold;
        }

        /* ===== END: 修正後的樣式 ===== */

        .LogEDIT_P {
            text-decoration: underline;
            font-weight: bold;
            color: #B15BFF;
            cursor: pointer;
        }

        .LogEDIT {
        }

        /* ===== START: 其他費用編輯表單的表格樣式 ===== */

        /* 讓表單表格寬度自適應，不再強制100% */
        .fee-form-table {
            border-collapse: collapse;
            width: auto;
        }

            .fee-form-table td {
                border: none;
                padding: 6px;
                vertical-align: middle;
            }

                /* 設定標籤欄位的樣式 */
                .fee-form-table td.label-cell {
                    width: 80px; /* 仍然保持固定寬度，以對齊冒號 */
                    text-align: left;
                    font-weight: bold;
                    padding-right: 10px;
                }

        /* ===== END: 其他費用編輯表單的表格樣式 ===== */
    </style>
</head>
<body>
    <div class="container">
        <h3>核准放款表/佣金表</h3>

        <form id="filterForm" class="filter-form">
            <span id="filter-wrapper-bc">
                <label for="U_bc_title">區：</label>
                <select name="U_bc_title" id="U_bc_title">
                    <option value="">全部</option>
                    <option value="666">六區</option>
                </select>
            </span>
            <span id="filter-wrapper-plan">
                <label for="plan_num">業務：</label>
                <input type="hidden" name="plan_num" id="U_num" value="">
                <input type="text" name="plan_name" id="U_name" size="10" maxlength="10" class="box" value="" readonly="" style="background-color: #f0f0f0;">
                <input type="button" id="btnSelectUser" value="...">
            </span>
            <label for="CS_introducer">介紹人：</label>
            <input type="text" id="CS_introducer" name="CS_introducer">

            <label for="SelYear_S">撥款年月：</label>
            <select id="SelYear_S" name="SelYear_S"></select>

            <label for="OrderBy">排序：</label>
            <select name="OrderBy" id="OrderBy">
                <option value="2" selected>區-業務</option>
                <option value="1">撥款日期</option>
            </select>
            <input type="hidden" id="U_num" name="U_num" />
            <input type="hidden" id="U_BC" name="U_BC" />
            <button type="submit">查詢</button>
            <button type="button" id="btnExport">匯出 Excel</button>


        </form>
        <div class="info-bar">
            <span class="status-label unfulfilled">＊未齊件＊</span>
            <span id="otherFeesText" class="status-label other-fees"></span>
        </div>
        <div id="gridContainer" class="grid-container">
            <table id="MainTable">
                <thead>
                    <tr>
                        <th class="frozen-col">No.</th>
                        <th class="frozen-col">區</th>
                        <th class="frozen-col">進件日</th>
                        <th class="frozen-col">申請人</th>
                        <th class="frozen-col">介紹人</th>
                        <th>ID</th>
                        <th>銀行名稱</th>
                        <th>銀行帳號</th>
                        <th>業務</th>
                        <th>核准日</th>
                        <th>核准金額(萬)</th>
                        <th>撥款日</th>
                        <th>撥款金額(萬)</th>
                        <th>專案</th>
                        <th>貸款成數(%)</th>
                        <th>原始利率(%)</th>
                        <th>承作利率(%)</th>
                        <th>收費</th>
                        <th>代書費用</th>
                        <th>對保費</th>
                        <th>補貼代書費</th>
                        <th>補貼過車費</th>
                        <th>結餘</th>
                        <th>補貼息</th>
                        <th>退傭備註</th>
                        <th>預估退佣金</th>
                        <th>作業服務費</th>
                        <th>實際退佣金</th>
                        <th>委對/外對</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                </tfoot>
            </table>
        </div>
    </div>
</body>
</html >
<script >
    document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('filterForm');
            const tbody = document.querySelector('#MainTable tbody');
            const tfoot = document.querySelector('#MainTable tfoot');
            const gridContainer = document.getElementById('gridContainer');
            const exportButton = document.getElementById('btnExport');
            //const monthInput = document.getElementById('SelYear_S');
            const monthSelect = document.getElementById('SelYear_S'); // 變更名稱以符合 select
            const otherFeesText = document.getElementById('otherFeesText');
            const uBcTitleSelect = document.getElementById('U_bc_title');
            const btnSelectUser = document.getElementById('btnSelectUser');
            // const orderByInput = document.getElementById('OrderBy');
            
            // API 端點
            const API_URL = `${BASE_URL}/AE_RPT/Approval_Loan_Sales_LQuery`;
            const ROLE_API_URL = `${BASE_URL}/AE_RPT/GetRoleNum`;
            const commissionApiUrl = `${BASE_URL}/AE_RPT/GetCommissionRules`;
            const OTHER_FEES_DETAILS_API_URL = `${BASE_URL}/AE_RPT/GetOtherFeeDetails`;
            const FEE_LOGS_API_URL = `${BASE_URL}/AE_RPT/GetFeeLogs`;
            const SAVE_FEES_API_URL = `${BASE_URL}/AE_RPT/SaveOtherFees`;
            const BRANCHES_API_URL = `${BASE_URL}/AE_RPT/GetBranches`;
            const MONTHS_API_URL = `${BASE_URL}/AE_RPT/GetDisbursementMonths`;

            // 變數宣告
            let displayAMT = 'Y';
            let isEditOtherFee = false;
            let currentTotalOtherAmount = 0; // 用於儲存當前查詢的其他費用總額，供彈出視窗使用
            //let lastFetchedData = []; // 用於儲存最新查詢結果的變數
            let reportCache = {
                data: [],
                totals: {},
                misalignedTotals: {},
                misalignedCount: 0,
                totalOtherAmount: 0
            };
            console.log("%c[偵錯] 1. 腳本初始化，reportCache 初始狀態:", "color: gray;", reportCache);

            let currentUserAuth = '';
            let userBC = '';
            // 事件委派監聽
            // 業務-選擇按鈕綁定點擊事件
            btnSelectUser.addEventListener('click', () => {
                // 判斷當前使用者是否為主管
                if (currentUserAuth === 'Man') {
                    // 如果是主管，呼叫 openUserOne，傳入他自己的分公司代碼並要求鎖定
                    console.log(`主管模式：鎖定分公司為 ${userBC}`);
                    openUserOne('appUser', userBC, 'Y');
                } else {
                    // 如果是其他角色 (如 Adm)，則使用舊的呼叫方式，不鎖定分公司
                    openUserOne('appUser');
                }
            });
            tbody.addEventListener('click', (e) => {
                // 尋找被點擊元素或其父層中，最近的帶有 data-action 的元素
                let target;
                target = e.target.closest('[data-action="open-commission-rules"]');
                if (target) {
                    const hsId = target.dataset.hsId;
                    const isConfirm = target.dataset.isConfirm;
                    openCommissionRulesModal(hsId, isConfirm);
                    return; // 處理完畢，結束
                }
                // 檢查是否點擊了「國興佣金參考」連結
                target = e.target.closest('[data-action="open-kf-comm-rate"]');
                if (target) {
                    const hsId = target.dataset.hsId;
                    const isConfirm = target.dataset.isConfirm;
                    openKF_CommRate(hsId, isConfirm); // 呼叫對應的函式
                    return; // 處理完畢，結束
                }

                // 未來可以在此處新增對 .LogEDIT 等其他可點擊元素的處理
            });
            // 初始化
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const params = buildQueryParams();
                await fetchDataAndRender(params);
            });
            // "其他費用" 文字標籤新增點擊事件
            otherFeesText.addEventListener('click', openOtherFeesModal);
            // 匯出 Excel
            exportButton.addEventListener('click', exportToExcel);

            // 獲取資料並渲染表格
            async function fetchDataAndRender(queryParams) {
                console.log("%c[偵錯] 2. fetchDataAndRender - 開始執行", "color: blue;");                
                console.log("%c================ 新查詢開始 ================", "color: green; font-size: 16px;");
                console.log("1. 進入 fetchDataAndRender，查詢參數:", queryParams.toString());
                
                const tbody = document.querySelector('#MainTable tbody');
                const tfoot = document.querySelector('#MainTable tfoot');
                tbody.innerHTML = '<tr><td colspan="28">讀取中...</td></tr>';
                tfoot.innerHTML = '';
                // 先顯示計算中的提示
                const selectedMonth = queryParams.get('SelYear_S');
                const uBcTitle = queryParams.get('U_bc_title') || '';
                otherFeesText.textContent = `其他費用(${selectedMonth}): 計算中...`;
                

                try {
                    const reportBody = JSON.stringify(Object.fromEntries(queryParams));
                    console.log("2. 準備發送並行 API 請求...");

                    // 1. 建立兩個並行的 API 請求 Promise
                    const reportPromise = fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: reportBody
                    });
                    const feesDetailsPromise = fetch(`${OTHER_FEES_DETAILS_API_URL}?u_bc_title=${uBcTitle}&selYear_S=${selectedMonth}`);
                    // 2. 等待兩個請求都完成
                    const [reportResponse, feesDetailsResponse] = await Promise.all([reportPromise, feesDetailsPromise]);
                    
                    //console.log("3. 兩個 API 皆已回傳。主報表狀態:", reportResponse.status, "費用明細狀態:", feesDetailsResponse.status);                    
                    
                    // 檢查兩個回應是否都成功
                    if (!reportResponse.ok) throw new Error(`主報表 API 錯誤! 狀態: ${reportResponse.status}`);
                    if (!feesDetailsResponse.ok) throw new Error(`其他費用明細 API 錯誤! 狀態: ${feesDetailsResponse.status}`);
                    const reportResponseData = await reportResponse.json();
                    const feesDetailsData = await feesDetailsResponse.json();
                    // **步驟 1**: 從信封物件中，解析出真正的資料陣列
                    let mainData = [];
                    if (reportResponseData && Array.isArray(reportResponseData)) {
                        mainData = reportResponseData;
                    } else {
                        alert(reportResponseData.resultMsg || "主報表 API 回傳資料有誤");
                    }
    
                    // **步驟 2**: 同樣地，也解析費用明細 (假設它也是信封格式)
                    let details = [];
                    if (feesDetailsData && Array.isArray(feesDetailsData)) {
                        details = feesDetailsData;
                    } else if (feesDetailsData) {
                        alert(feesDetailsData.resultMsg || "其他費用明細 API 回傳資料有誤");
                    }
    
                    console.log("3. API 資料已解析，準備傳遞給 renderTable 的 mainData 筆數:", mainData.length);                    
                    
                    //console.log("4. 兩個 API 的 JSON 都已解析完畢。");
                    //console.log("[偵錯] 主報表解析後的物件:", reportResponseData);
                    //console.log("[偵錯] 費用明細解析後的物件:", feesDetailsData);
                    
                    // 加上一層保護，確保我們收到的確實是陣列
                    if (!Array.isArray(mainData) || !Array.isArray(details)) {
                        throw new Error("API 回應的資料格式不是預期的陣列。");
                    }
                    // 計算"其他費用"總額
                    const totalOtherAmount = details.reduce((sum, item) => {
                        return sum + (Number(item.TotAmt) || 0);
                    }, 0);

                    //console.log(`totalOtherAmount=${totalOtherAmount}`)

                    // 將"其他費用"總額存到的狀態變數中
                    currentTotalOtherAmount = totalOtherAmount;
                    // 將"其他費用"總額傳遞給 renderTable 以更新表尾
                    // 更新"其他費用" UI 文字
                    otherFeesText.textContent = `其他費用(${selectedMonth}): ${formatNumber(currentTotalOtherAmount)}`;

                    //console.log("5. 準備呼叫 renderTable 來更新畫面與快取...");
                    console.log("[偵錯] 3. fetchDataAndRender - API 資料已獲取，準備傳遞給 renderTable:", mainData);
                    renderTable(mainData, currentTotalOtherAmount);
                    
                    
                    //console.log("9. UI 更新完成。");
                } catch (error) {
                    tbody.innerHTML = `<tr><td colspan="28">資料載入失敗: ${error.message}</td></tr>`;
                    console.error("fetchDataAndRender 函式捕捉到錯誤:", error); // 在 Console 中顯示詳細錯誤
                    otherFeesText.textContent = `其他費用(${selectedMonth}): 查詢失敗`;
                    alert(`查詢過程中發生錯誤，請按F12查看主控台以獲取詳細資訊。\n\n錯誤訊息: ${error.message}`);
                }
            }
            // 這個函式會複製 API 回應，讓我們可以安全地讀取兩次 (一次作為文字，一次作為JSON)
            async function logAndParseResponse(response, name) {
                const clonedResponse = response.clone();
                const rawText = await clonedResponse.text();
                console.log(`%c[偵錯] ${name} API 的原始回應文字:`, 'color: blue; font-weight: bold;', rawText);
        
                try {
                    // 嘗試解析原始的回應
                    return await response.json();
                } catch (e) {
                    console.error(`!!!! ${name} API 的回應不是有效的 JSON 格式 !!!!`, e);
                    throw new Error(`${name} API 回應格式錯誤，無法解析。`);
                }
            }
            /**
             * 渲染表格內容，並根據原始命名慣例進行計算與顯示
             * @param {Array} data - 從 API 獲取的資料陣列
             */
            function renderTable(data, totalOtherAmount) {
                console.log("%c[偵錯] 4. renderTable - 開始執行，收到的 data 筆數:", (data ? data.length : 'undefined'));

                const tbody = document.querySelector('#MainTable tbody');
                const tfoot = document.querySelector('#MainTable tfoot');
                tbody.innerHTML = '';
                tfoot.innerHTML = '';

                // 先將 reportCache 清空或設為當前狀態，即使沒有資料也要更新
                if (!data || !Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="29">查無資料</td></tr>';
                    // 當查無資料時，也要清空快取，確保匯出時也是空的
                    reportCache = {
                        data: [], totals: {}, misalignedTotals: {},
                        misalignedCount: 0, totalOtherAmount: 0
                    };
                    console.log("renderTable 執行完畢：查無資料，reportCache 已清空。");
                    return; // 結束函式
                }

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="28">查無資料</td></tr>';
                    return;
                }

                // 1. 初始化總計物件 (使用與 SQL 別名一致的命名)
                const totals = { pass_amount: 0, get_amount: 0, charge_flow: 0, charge_agent: 0, charge_check: 0, Subsidy_agent: 0, Subsidy_amt: 0, get_amount_final: 0, subsidized_interest: 0, Expe_comm_amt: 0, act_service_amt: 0, act_comm_amt: 0 };
                const misalignedTotals = { pass_amount: 0, get_amount: 0, charge_flow: 0, charge_agent: 0, charge_check: 0, Subsidy_agent: 0, Subsidy_amt: 0, get_amount_final: 0, subsidized_interest: 0, Expe_comm_amt: 0, act_service_amt: 0, act_comm_amt: 0 };
                let misalignedCount = 0;
                let footerRowsCount = 0; // 記錄表尾的行數
                const selYearS = document.getElementById('SelYear_S').value;

                //let temp_commissionData = 0;
                //let temp_actualCommCell = 0;

                data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    const IsmisalignedSUM = (row.misaligned_date && row.Ismisaligned === 'ThisMon') ? 'Y' : 'N';
    
                    if (row.isCancel === 'Y') tr.classList.add('is-cancel');
                    if (IsmisalignedSUM === 'Y') tr.classList.add('is-red');

                    // 先計算作業服務費，因為實際退佣金會用到它
                    const commissionData = generateCommissionCells(row, displayAMT, IsmisalignedSUM, selYearS, index);
                    
                    //temp_commissionData = temp_commissionData + commissionData.estimatedCommission.numericValue;
                    //console.log(`${row.CS_name} commissionData=${commissionData.estimatedCommission.numericValue} total=${temp_commissionData}`);

                    // 呼叫新的輔助函式計算實際退佣金
                    const actualCommCell = generateActualCommissionCell(row, displayAMT, IsmisalignedSUM, commissionData.serviceFee.numericValue);

                    //temp_actualCommCell = temp_actualCommCell + actualCommCell.numericValue;
                    //console.log(`actualCommCell=${actualCommCell.numericValue} total=${temp_actualCommCell}`);

                    //console.log(`${row.show_fund_company} - ${row.show_project_title}`);
                    const commRemarkDisplay = (displayAMT === 'Y') ? (row.Comm_Remark || '') : 'NA';

                    // 3. 渲染 <tr> (使用與 SQL 別名一致的命名)
                    tr.innerHTML = `
                        <td class="frozen-col">${index + 1}</td>
                        <td class="frozen-col">${row.U_BC_name || ''}</td>
                        <td class="frozen-col">${row.Send_amount_date || ''}</td>
                        <td class="frozen-col">${row.CS_name || ''}</td>
                        <td class="frozen-col">${row.CS_introducer || ''}</td>
                        <td>${row.Introducer_PID || ''}</td>                        
                        <td>${row.Bank_name || ''}</td><td>${row.Bank_account || ''}</td><td>${row.plan_name || ''}</td>
                        <td>${row.Send_result_date || ''}</td><td>${formatNumber(row.pass_amount)}</td><td>${row.get_amount_date || ''}</td>
                        <td>${formatNumber(row.get_amount)}</td><td>${row.show_fund_company || ''}-${row.show_project_title || ''}</td>
                        <td>${row.Loan_rate || ''}</td><td>${row.interest_rate_original || ''}</td><td>${row.interest_rate_pass || ''}</td>
                        <td>${formatNumber(row.charge_flow)}</td><td>${formatNumber(row.charge_agent)}</td>
                        <td>${formatNumber(row.charge_check)}</td>
                        <td>${formatNumber(row.Subsidy_agent)}</td>
                        <td>${formatNumber(row.Subsidy_amt)}</td>
                        <td>${formatNumber(row.get_amount_final)}</td>
                        <td>${formatNumber(row.subsidized_interest)}</td>
                        <td>${commRemarkDisplay}</td>
                        ${commissionData.estimatedCommission.html} ${commissionData.serviceFee.html} ${actualCommCell.html}
                        <td>${row.Comparison || ''}</td>
                    `;
                    tbody.appendChild(tr);

                    // 5. 處理未取消的案件
                    if (row.isCancel !== 'Y') {
                        // 4. 如果是「當月未齊件」，則計入 misalignedTotals
                        if (IsmisalignedSUM  === 'Y'){
                            misalignedCount++;
                            // 其他欄位的未齊件合計也可以在此加入
                            misalignedTotals.pass_amount += Number(row.pass_amount) || 0;
                            misalignedTotals.get_amount  += Number(row.get_amount ) || 0;
                            misalignedTotals.charge_flow += Number(row.charge_flow) || 0;
                            misalignedTotals.charge_agent += Number(row.charge_agent) || 0;
                            misalignedTotals.charge_check += Number(row.charge_check) || 0;
                            misalignedTotals.Subsidy_agent += Number(row.Subsidy_agent) || 0;
                            misalignedTotals.Subsidy_amt += Number(row.Subsidy_amt) || 0;
                            misalignedTotals.get_amount_final += Number(row.get_amount_final) || 0;
                            misalignedTotals.subsidized_interest += Number(row.subsidized_interest) || 0;
                            //misalignedTotals.Expe_comm_amt += commissionData.estimatedCommission.numericValue || 0;
                            //misalignedTotals.act_service_amt += commissionData.serviceFee.numericValue || 0;
                            //misalignedTotals.act_comm_amt += actualCommCell.numericValue || 0;
                        }
                        // 1.2 如果是「正常案件」(無補登日期)，則所有金額計入 totals
                        else if(!row.misaligned_date) {
                                totals.pass_amount += Number(row.pass_amount) || 0;
                                totals.get_amount += Number(row.get_amount) || 0;
                                totals.charge_flow += Number(row.charge_flow) || 0; // 
                                totals.charge_agent += Number(row.charge_agent) || 0; // 
                                totals.charge_check += Number(row.charge_check) || 0; // 對保費
                                totals.Subsidy_agent += Number(row.Subsidy_agent) || 0;
                                totals.Subsidy_amt += Number(row.Subsidy_amt) || 0;
                                totals.get_amount_final += Number(row.get_amount_final) || 0; // 對保費
                                totals.subsidized_interest += Number(row.subsidized_interest) || 0; // 對保費                                
                                totals.Expe_comm_amt += commissionData.estimatedCommission.numericValue || 0;
                                totals.act_service_amt += commissionData.serviceFee.numericValue || 0;
                                totals.act_comm_amt += actualCommCell.numericValue || 0;

                                //console.log(`正常案件 ${row.CS_name} ${commissionData.estimatedCommission.numericValue} ${totals.Expe_comm_amt} ${temp_commissionData}`);

                       } 
                       // 1.3 處理「從過去補登的案件」(misaligned_date 有值，但 IsmisalignedSUM 為 'N')
                       else {
                           totals.Expe_comm_amt += commissionData.estimatedCommission.numericValue || 0;
                           totals.act_service_amt += commissionData.serviceFee.numericValue || 0;
                           totals.act_comm_amt += actualCommCell.numericValue || 0;

                           //console.log(`過去補登的案件 ${row.CS_name} ${commissionData.estimatedCommission.numericValue} ${totals.Expe_comm_amt} ${temp_commissionData}`);

                       }
                    }
                    // 2. 處理已取消的案件
                    else {
                        // 2.1 如果是「當月取消」，則所有金額都計入 totals 以進行沖銷
                        if (row.isThisMonCancel === 'Y') {
                            totals.pass_amount += Number(row.pass_amount) || 0;
                            totals.get_amount += Number(row.get_amount) || 0;
                            totals.charge_flow += Number(row.charge_flow) || 0;
                            totals.charge_agent += Number(row.charge_agent) || 0;
                            totals.charge_check += Number(row.charge_check) || 0;
                            totals.Subsidy_agent += Number(row.Subsidy_agent) || 0;
                            totals.Subsidy_amt += Number(row.Subsidy_amt) || 0;
                            totals.get_amount_final += Number(row.get_amount_final) || 0;
                            totals.subsidized_interest += Number(row.subsidized_interest) || 0;
                        }
                        totals.Expe_comm_amt += commissionData.estimatedCommission.numericValue || 0;
                        totals.act_service_amt += commissionData.serviceFee.numericValue || 0;
                        totals.act_comm_amt += actualCommCell.numericValue || 0;

                        //console.log(`當月取消  ${row.CS_name} ${commissionData.estimatedCommission.numericValue} ${totals.Expe_comm_amt} ${temp_commissionData}`);
                    }
                });

                // 如果其他費用>0，先插入「其他費用」摘要列
                if (totalOtherAmount > 0) {
                    const otherFeesRow = document.createElement('tr');
                    // 白色底色
                    otherFeesRow.style.backgroundColor = '#fff'; 
        
                    // 找到「對保費」(第20欄) 和「結餘」(第21欄) 的位置
                    otherFeesRow.innerHTML = `
                        <td colspan="21"></td>
                        <td style="text-align:right; font-weight:bold;">其他費用:</td>
                        <td style="color:red; font-weight:bold;">-${formatNumber(totalOtherAmount)}</td>
                        <td colspan="6"></td>
                    `;
                    tfoot.appendChild(otherFeesRow);
                    footerRowsCount++;
                }

                // 從總計的「結餘」中減去其他費用
                totals.get_amount_final -= totalOtherAmount;

                // 5. 渲染表尾 (使用與 SQL 別名一致的命名)
                const footerRow = document.createElement('tr');
                footerRow.classList.add('footer-row-misaligned');
                footerRow.innerHTML = `
                    <td class="frozen-col" colspan="5">總筆數: ${data.length}</td>
                    <td colspan="6"></td>
                    <td style="text-align:right;">合計:</td>
                    <td>${formatNumber(totals.get_amount)}</td>
                    <td colspan="4"></td><td>${formatNumber(totals.charge_flow)}</td><td>${formatNumber(totals.charge_agent)}</td>
                    <td>${formatNumber(totals.charge_check)}</td>
                    <td>${formatNumber(totals.Subsidy_agent)}</td>
                    <td>${formatNumber(totals.Subsidy_amt)}</td>
                    <td>${formatNumber(totals.get_amount_final)}</td>
                    <td>${formatNumber(totals.subsidized_interest)}</td><td></td><td>${formatNumber(totals.Expe_comm_amt)}</td>
                    <td>${formatNumber(totals.act_service_amt)}</td><td>${formatNumber(totals.act_comm_amt)}</td><td></td>
                `;
                tfoot.appendChild(footerRow);
                footerRowsCount++;

                // 表尾:未齊件筆數
                if (misalignedCount > 0) {
                    const misalignedFooterRow = document.createElement('tr');
                    misalignedFooterRow.classList.add('footer-row-misaligned');
                    misalignedFooterRow.innerHTML = `
                        <td class="frozen-col"  colspan="5">未齊件筆數: ${misalignedCount}</td>
                        <td colspan="6"></td>
                        <td style="text-align:right;">未齊件合計:</td>
                        <td>${formatNumber(misalignedTotals.get_amount)}萬</td>
                        <td colspan="4"></td><td>${formatNumber(misalignedTotals.charge_flow)}</td><td>${formatNumber(misalignedTotals.charge_agent)}</td>
                        <td>${formatNumber(misalignedTotals.charge_check)}</td>
                        <td>${formatNumber(misalignedTotals.Subsidy_agent)}</td>
                        <td>${formatNumber(misalignedTotals.Subsidy_amt)}</td>
                        <td>${formatNumber(misalignedTotals.get_amount_final)}</td>
                        <td>${formatNumber(misalignedTotals.subsidized_interest)}</td><td colspan="5"></td>
                    `;

                    tfoot.appendChild(misalignedFooterRow);
                    footerRowsCount++;
                }
                // 快取都會被最新的計算結果覆蓋
                console.log("[偵錯] 5. renderTable - 準備更新 reportCache，更新前的 reportCache.data 筆數:", reportCache.data.length);

                reportCache = {
                    data: data,
                    totals: totals,
                    misalignedTotals: misalignedTotals,
                    misalignedCount: misalignedCount,
                    totalOtherAmount: totalOtherAmount,
                    footerRowsCount: footerRowsCount
                };

                console.log("%c[偵錯] 6. renderTable - 更新完成，更新後的 reportCache:", "color: green; font-weight: bold;", reportCache);
            }

            function formatNumber(num) {
                if (num === null || num === undefined) return '';
                // 簡單的千分位格式化，不處理小數
                return Math.round(num).toLocaleString('en-US');
            }

            /**
             * 根據角色代碼返回權限角色字串
             * @param {string} roleNum - 使用者角色代碼
             * @returns {string} 'Adm', 'Man', 'Asi', 'Sal'
             */
            function getAuth(roleNum) {
                const manRoles = ["1008", "1014"];
                const salRoles = ["1009", "1017"];
                const asiRoles = ["1010"];
                const admRoles = ["1004", "1007", "1001"];

                if (manRoles.includes(roleNum)) return 'Man';
                if (salRoles.includes(roleNum)) return 'Sal';
                if (asiRoles.includes(roleNum)) return 'Asi';
                if (admRoles.includes(roleNum)) return 'Adm';
        
                return 'Guest'; // 預設或未知角色
            }

            /**
             * 根據權限角色初始化UI介面(顯示/隱藏元件)
             * @param {string} auth - 權限角色 ('Adm', 'Man', etc.)
             */
            function initializeUI(auth) {
                const bcFilterWrapper = document.getElementById('filter-wrapper-bc');
                const planFilterWrapper = document.getElementById('filter-wrapper-plan');

                // 預設全部隱藏
                bcFilterWrapper.style.display = 'none';
                planFilterWrapper.style.display = 'none';
        
                // 根據權限顯示
                // 1. 區(U_bc_title) 只限 adm
                if (auth === 'Adm') {
                    bcFilterWrapper.style.display = 'inline-block';
                }
        
                // 2. 業務(plan_num) 只限 adm or Man
                if (auth === 'Adm' || auth === 'Man') {
                    planFilterWrapper.style.display = 'inline-block';
                }

                // 根據 DisplayAMT 標籤控制「預估退佣金」欄位的顯示
                // if (displayAMT === 'N') {
                //     gridContainer.classList.add('hide-column-23');
                // } else {
                //     gridContainer.classList.remove('hide-column-23');
                // }

                const selYearS = document.getElementById('SelYear_S').value;
                if (isEditOtherFee && selYearS >= '2025-01') {
                    otherFeesText.classList.add('other-fees-link');
                } else {
                    otherFeesText.classList.remove('other-fees-link');
                }
            }

            /**
             * 獲取使用者角色
             * 根據 U_num 非同步獲取 Role_num
             * @param {string} userNum - 使用者編號
             * @returns {Promise<string>} 使用者角色代碼
             */
            async function fetchRoleNum(userNum) {
                if (!userNum) {
                    console.warn("U_num 不存在，無法獲取角色。");
                    return 'Guest'; // 返回一個訪客角色
                }
                try {
                    // 假設 API 是 GET 請求，並透過 query string 傳遞參數
                    const response = await fetch(`${ROLE_API_URL}?U_num=${userNum}`);
                    if (!response.ok) {
                        throw new Error(`獲取角色失敗，伺服器回應: ${response.status}`);
                    }
                    const responseData = await response.json();
                    if (responseData.resultCode=="400" || !responseData.objResult) {
                         throw new Error("查無資料");
                    }
                    return responseData.objResult;
                } catch (error) {
                    console.error("fetchRoleNum 函式出錯:", error);
                    alert("無法獲取您的使用者權限，部分功能可能無法使用。");
                    return 'Guest'; // 發生錯誤時，返回安全的訪客角色
                }
            }

            /**
             * 建立並返回查詢參數，包含新的預設日期邏輯
             * @returns {URLSearchParams}
             */
            function buildQueryParams() {
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                const URLParams = getQueryParams();
                params.set('U_num', URLParams.WebUser);
                params.set('U_BC', URLParams.WebBC);

                return params;
            }
            // 獲取並填充分公司下拉選單 =====
            async function populateBranchDropdown(defaultBranchCode) {
                try {
                    const response = await fetch(BRANCHES_API_URL);
                    if (!response.ok) {
                        throw new Error('無法載入分公司列表');
                    }
                    const responseData = await response.json();
                    if (responseData.resultCode=="400" || !responseData.objResult) {
                            throw new Error("查無資料");
                    }
                    const branches = await JSON.parse(responseData.objResult);
                    // 建立文件片段 (DocumentFragment) 以提高效能
                    const fragment = document.createDocumentFragment();
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.BranchCode; // 對應 BranchDto.BranchCode
                        option.textContent = branch.BranchName; // 對應 BranchDto.BranchName
                        fragment.appendChild(option);
                    });
    
                    // 一次性將所有新選項加入到 select 中
                    uBcTitleSelect.appendChild(fragment);

                    // 根據傳入的 userBC 設定預設選中項
                    if (defaultBranchCode && uBcTitleSelect.querySelector(`option[value="${defaultBranchCode}"]`)) {
                        uBcTitleSelect.value = defaultBranchCode;
                    }

                } catch (error) {
                    console.error("載入分公司下拉選單失敗:", error);
                    // 可以在此處顯示一個對使用者更友好的錯誤提示
                }
            }
            /**
             * 獲取並填充分公司下拉選單 =====
             */
            async function populateMonthDropdown() {
                try {
                    const response = await fetch(MONTHS_API_URL);
                    if (!response.ok) throw new Error('無法載入撥款年月列表');
                    const responseData = await response.json();
                    if (responseData.resultCode=="400" || !responseData.objResult) {
                            throw new Error("查無資料");
                    }
                    const months = await JSON.parse(responseData.objResult);
            
                    const fragment = document.createDocumentFragment();
                    months.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month.Yyyymm; // 值為 "2025-07"
                        option.textContent = month.YyyMM; // 顯示文字為 "114-07"
                        fragment.appendChild(option);
                    });
                    monthSelect.appendChild(fragment);
                } catch (error) {
                    console.error("載入撥款年月選單失敗:", error);
                }
            }
            /**
             * 根據日期規則，設定撥款年月的預設值
             */
            function setDefaultMonth() {
                const today = new Date();
                const dayOfMonth = today.getDate();
                let targetDate = new Date();
                if (dayOfMonth < 20) {
                    targetDate.setMonth(targetDate.getMonth() - 1);
                }
                const year = targetDate.getFullYear();
                const month = (targetDate.getMonth() + 1).toString().padStart(2, '0');
                const defaultValue = `${year}-${month}`;
        
                // 設定 <select> 的預設值
                if (monthSelect) {
                    monthSelect.value = defaultValue;
                }
            }
            // ===== START: 佣金彈窗相關函式 =====
            /**
             * 根據從 API 獲取的資料，建立彈出視窗的 HTML 內容
             * @param {Array} data - 佣金規則陣列
             * @param {string} isConfirm - 是否已確認 ('Y' or 'N')
             * @param {string} mainKey - 當前查詢的年月 (e.g., '2025-06')
             * @returns {string} HTML 字串
             */
            function buildCommissionModalHtml(data, isConfirm, mainKey) {
                if (!data || data.length === 0) {
                    return '<p>查無佣金參考資料。</p>';
                }

                let titleText  = "退佣參考-";
                let refHead = "";
                let colspan = 4;
    
                if (isConfirm === "Y") {
                    titleText  = "退佣參考-" + mainKey;
                    refHead = "<th>參考維護人</th><th>參考建立時間</th>";
                    colspan = 6;
                }

                let tableHtml = '<table id="RefInfo"><thead>';
                
    
                // 處理案件資訊
                const caseInfo = data.find(d => d.sel === 'Y') || data[0];
                if (caseInfo) {
                    // 1. 先將小數乘以 100，並用 toFixed(2) 處理浮點數誤差並四捨五入到兩位小數
                    const roundedPercentage  = (parseFloat(caseInfo.Discount || 0) * 100).toFixed(2);
                    // 2. 再用 parseFloat 將字串轉回數字，這個過程會自動移除尾部的 0
                    const commissionPercentage = parseFloat(roundedPercentage);
                    tableHtml += `<tr><th colspan="${colspan}">案件資訊</th></tr>`;
                    tableHtml += `<tr><td colspan="${colspan}" style="text-align:left; padding-left:10px;">` +
                                 `貸款成數: ${caseInfo.RefRateL}%; 承作利率: ${caseInfo.RefRateI}%; ` +
                                 `佣金: ${commissionPercentage}%; 撥款金額: ${caseInfo.GetAmount};<br>` +
                                 `(${caseInfo.GetAmount} * ${caseInfo.Discount} = ${caseInfo.Expe_comm_amt})` +
                                 `</td></tr>`;
                }
                
                tableHtml += `<tr><th>專案名稱</th><th>貸款成數</th><th>承作利率</th><th>佣金</th>${refHead}</tr></thead><tbody>`;

                data.forEach(row => {
                    const trClass = row.Sel === 'Y' ? 'class="Sel"' : '';
                    let refBody = "";
                    if (isConfirm === "Y") {
                        refBody = `<td>${row.RefName || ''}</td><td>${row.RefDate || ''}</td>`;
                    }
                    tableHtml += `<tr ${trClass}>
                                    <td>${row.FR_M_name}</td>
                                    <td>${row.FR_D_ratio_A}～${row.FR_D_ratio_B}%</td>
                                    <td>${row.FR_D_rate}%</td>
                                    <td>${row.FR_D_discount}%</td>
                                    ${refBody}
                                  </tr>`;
                });

                tableHtml += '</tbody></table>';
                const finalHtml = `
                    <div class="custom-modal-wrapper">
                        <div class="custom-modal-title">${titleText}</div>
                        <div class="custom-modal-content">
                            ${tableHtml}
                        </div>
                    </div>
                `;
                return finalHtml;
            }

            /**
             * 開啟佣金參考的彈出視窗
             * @param {string} hsId - 案件 ID
             * @param {string} isConfirm - 是否已確認 ('Y' or 'N')
             */
            async function openCommissionRulesModal(hsId, isConfirm) {
                const mainKey = document.getElementById('SelYear_S').value;
                try {
                    const response = await fetch(`${commissionApiUrl}?hsId=${hsId}&isConfirm=${isConfirm}&mainKey=${mainKey}`);
                    if (!response.ok) {
                        throw new Error(`API 請求失敗: ${response.status}`);
                    }
                    const responseData = await response.json();
                    if (responseData.resultCode=="400" || !responseData.objResult) {
                         throw new Error("查無資料");
                    }
                    const data = await JSON.parse(responseData.objResult);
                    const modalHtml = buildCommissionModalHtml(data, isConfirm, mainKey);

                    $.blockUI({
                        message: modalHtml,
                        onOverlayClick: $.unblockUI,
                        css: {
                            width: isConfirm === 'Y' ? '650px' : '550px',
                            top: '20%',
                            left: '30%',
                            border: '1px solid #999',
                            padding: '0',
                            backgroundColor: '#fff',
                            color: '#000',
                            cursor: 'default'
                        },
                        overlayCSS: {
                            backgroundColor: '#000',
                            opacity: 0.6,
                            cursor: 'wait'
                        }
                    });
                    // 讓彈出視窗可以被拖曳
                    $('.blockMsg').draggable({
                        handle: ".custom-modal-title", // 指定只能透過標題列拖曳
                        cursor: "move"
                    });
                } catch (error) {
                    console.error("開啟佣金參考視窗失敗:", error);
                    alert("無法獲取佣金參考資料。");
                }
            }
            // ===== END: 佣金彈窗相關函式 =====
            /**
             * 產生「作業服務費」儲存格的 HTML 內容與屬性
             * @param {object} row - 單筆案件資料
             * @param {string} displayAMT - 'Y' 或 'N'，決定是否顯示金額
             * @param {string} selYearS - 當前查詢的年月，用於日期比較
             * @param {number} index - 當前資料的索引
             * @returns {{html: string}} 一個包含完整 <td> HTML 的物件
             */
            function generateServiceFeeCell(row, displayAMT, selYearS, index) {
                let act_service_amt = 0;
                let isPlus = "";
                let isSer = row.isSer;
                let Expe_comm_amt = 0;
                let IsmisalignedSUM = (row.misaligned_date !== "" && row.Ismisaligned !== 'ThisMon') ? 'Y' :'N';

                if(displayAMT === 'Y')
                {
                    if(row.CaseType === 'sendcase'){
                        if(row.IsConfirm === 'Y'){
                            Expe_comm_amt = row.Expe_comm_amt_firm || 0;
                        }else {
                            Expe_comm_amt = row.Expe_comm_amt || 0;
                        }
                    } 
                }
                
                // 1. 條件計算：只有在 isSer 為 'Y' 且非當月補登案件時才計算
                //    (row.Ismisaligned === 'ThisMon' 代表是當月補登的案件)
                if (IsmisalignedSUM ==='N' && isSer === 'Y') {
                    // ASP 邏輯: act_service_amt = Expe_comm_amt * service_Rate
                    const calculated_amt = (Number(Expe_comm_amt) || 0) * (Number(row.service_Rate) || 0);

                    // 2. 無條件進位 (等同於 Math.ceil)
                    act_service_amt = Math.ceil(calculated_amt);

                    // 如果有進行進位，記錄 isPlus 字串用於 title 提示
                    if (act_service_amt > calculated_amt) {
                        isPlus = `${calculated_amt.toFixed(4)} --> ${act_service_amt}`;
                    }
                } else {
                    isSer = 'N'; // 不滿足條件的，視為不適用
                }

                // 3. 狀態覆蓋：如果案件已確認，直接使用資料庫的值
                if (isSer === 'Y' && row.IsConfirm === 'Y') {
                    act_service_amt = Number(row.act_service_amt) || 0;
                    isPlus = ""; // 已確認案件，無需顯示計算過程
                }

                // 4. 動態屬性：根據條件組合 class 和 title
                const attributes = {
                    class: '',
                    title: '',
                    'data-logtable': 'House_sendcase',
                    'data-ubc': row.U_BC,
                    'data-displayna': '作業服務費',
                    'data-columna': 'act_service_amt',
                    'data-rowidx': index,
                    id: `tdact_service_amt${index}`
                };

                if (isSer === 'Y') {
                    if (isPlus && selYearS >= '2024-10') {
                        attributes.class = 'LogEDIT_P';
                        attributes.title = isPlus;
                    } else {
                        attributes.class = 'LogEDIT';
                    }
                }
                if (row.IsConfirm === 'N') {
                    attributes['data-init'] = 'Y';
                }

                // 將屬性物件轉換為 HTML 字串
                const attrString = Object.entries(attributes)
                    .filter(([key, value]) => value) // 過濾掉空值
                    .map(([key, value]) => `${key}="${value}"`)
                    .join(' ');
    
                // 5. 權限顯示：決定最終顯示的文字
                let displayText = 'NA';
                if (displayAMT === 'Y' && isSer === 'Y') {
                    displayText = formatNumber(act_service_amt);
                }
    
                return {
                    html: `<td ${attrString}>${displayText}</td>`,
                    value: act_service_amt // 返回計算值，用於總計
                };
            }
            /**
             * ===== START: 開啟其他費用明細的彈出視窗 =====
             * 根據權限決定開啟「唯讀明細」或「編輯表單」的彈出視窗
             */
            async function openOtherFeesModal() {
                const selYearS = document.getElementById('SelYear_S').value;
                const uBcTitle = document.getElementById('U_bc_title').value;
                const uBcTitleText = $('#U_bc_title option:selected').text();

                // 條件分流
                // 編輯模式: 有編輯權限，且選擇了單一分公司
                if (isEditOtherFee && !(uBcTitle=="" || uBcTitle == '666')) {
                    openEditableFeesForm(uBcTitle, uBcTitleText, selYearS);
                } 
                // 唯讀模式: 沒有編輯權限，或選擇了 "全部" 或 "六區"
                else {
                    openReadOnlyFeesDetails(uBcTitle, selYearS);
                }
            }
            /**
             * 開啟「唯讀」的其他費用明細彈出視窗
             */
            async function openReadOnlyFeesDetails(uBcTitle, selYearS) {
                if (selYearS < '2025-01') return; // 舊的日期檢查

                try {
                    const response = await fetch(`${OTHER_FEES_DETAILS_API_URL}?u_bc_title=${uBcTitle}&selYear_S=${selYearS}`);
                    if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`);
                    const details = await response.json();
                    const modalHtml = buildOtherFeesModalHtml(details, selYearS);

                    $.blockUI({
                        message: modalHtml,
                        onOverlayClick: $.unblockUI,
                        css: {
                            width: '650px', top: '15%', left: '30%', border: 'none',
                            padding: '0px', 
                            backgroundColor: '#fff', cursor: 'default',
                            '-webkit-border-radius': '10px', '-moz-border-radius': '10px',
                        },
                        overlayCSS: { backgroundColor: '#000', opacity: 0.6, cursor: 'wait' }
                    });

                    $('.blockMsg').draggable({
                        handle: ".custom-modal-title",
                        cursor: "move"
                    });
                } catch (error) {
                    console.error("開啟唯讀費用視窗失敗:", error);
                    alert("無法獲取其他費用明細。");
                }
            }
            /**
             * 根據從 API 獲取的資料，建立其他費用彈出視窗的 HTML 內容
             */
            function buildOtherFeesModalHtml(details, selYearS) {
                let tableHtml = `<table id="RefInfo">
                    <thead>
                        <tr><th colspan="7">各區 ${selYearS} 其他費用</th></tr>
                        <tr><th>區</th><th>清潔費</th><th>匯費</th><th>開工紅包</th><th>合計</th></tr>
                    </thead>
                    <tbody>`;

                const totals = { CleanAmt: 0, RemitAmt: 0, BonusAmt: 0, TotAmt: 0 };

                details.forEach(row => {
                    tableHtml += `<tr>
                                    <td>${row.ItemDName || ''}</td>
                                    <td>${formatNumber(row.CleanAmt)}</td>
                                    <td>${formatNumber(row.RemitAmt)}</td>
                                    <td>${formatNumber(row.BonusAmt)}</td>
                                    <td>${formatNumber(row.TotAmt)}</td>
                                  </tr>`;
                    // 累加總計
                    totals.CleanAmt += Number(row.CleanAmt) || 0;
                    totals.RemitAmt += Number(row.RemitAmt) || 0;
                    totals.BonusAmt += Number(row.BonusAmt) || 0;
                    totals.TotAmt += Number(row.TotAmt) || 0;
                });

                tableHtml += `</tbody>
                    <tfoot>
                        <tr>
                            <td>合計：</td>
                            <td>${formatNumber(totals.CleanAmt)}</td>
                            <td>${formatNumber(totals.RemitAmt)}</td>
                            <td>${formatNumber(totals.BonusAmt)}</td>
                            <td>${formatNumber(totals.TotAmt)}</td>
                        </tr>
                    </tfoot>
                </table>`;
                // 將表格包在我們自訂的標題和內容容器中
                const finalHtml = `
                    <div class="custom-modal-wrapper">
                        <div class="custom-modal-title">其他費用 (${selYearS})</div>
                        <div class="custom-modal-content">
                            ${tableHtml}
                        </div>
                    </div>
                    `;
                return finalHtml;
            }
            // ===== END: 新增函式 =====
            /**
             * 開啟「可編輯」的其他費用表單
             */
            async function openEditableFeesForm(uBcTitle, uBcTitleText, selYearS) {
                const keyVal = uBcTitle + selYearS;
                // **新增**: 建立一個物件，用來將欄位英文名對應到中文名稱
                const feeDescriptions = {
                    RemitAmt: "匯費",
                    CleanAmt: "清潔費",
                    BonusAmt: "開工紅包"
                };
                const feeTypes = Object.keys(feeDescriptions).join(','); // 從物件動態產生查詢字串

                console.log("開啟編輯/新增表單，準備獲取資料...");

                // 如果總額 > 0，則呼叫 API 獲取資料
                try {
                    // Use Promise.all to fetch current values and history logs concurrently
                    const valuesPromise = fetch(`${OTHER_FEES_DETAILS_API_URL}?u_bc_title=${uBcTitle}&selYear_S=${selYearS}`);
                    const logsPromise = fetch(`${FEE_LOGS_API_URL}?TableNA=OtherAmt&KeyVal=${keyVal}&ColumnNA=${feeTypes}`);
                    const [valuesResponse, logsResponse] = await Promise.all([valuesPromise, logsPromise]);

                    if (!valuesResponse.ok) throw new Error('無法獲取當前費用資料');
                    if (!logsResponse.ok) throw new Error('無法獲取歷史紀錄');

                    const details = await valuesResponse.json();
                    const logs = await logsResponse.json();

                    // 如果 API 回傳空陣列，currentValues 會是空物件 {}，輸入框預設為 0
                    const currentValues = (details && details.length > 0) ? details[0] : {};

                    // buildEditableFeeFormHtml 函式會自動根據 logs 是否為空陣列來決定是否顯示歷程
                    const modalHtml = buildEditableFeeFormHtml(currentValues, keyVal, logs, uBcTitleText, selYearS, feeDescriptions);
                    //console.log(`modalHtml=${modalHtml}`);
                    displayEditableForm(modalHtml);

                } catch (error) {
                    console.error("開啟編輯費用表單失敗:", error);
                    alert(error.message);
                }
            }
            function displayEditableForm(modalHtml) {
                $.blockUI({
                    message: modalHtml,
                    onOverlayClick: $.unblockUI,
                    css: {
                        width: '550px', top: '10%', left: '30%', border: '1px solid #999',
                        padding: '0', backgroundColor: '#fff', cursor: 'default',
                        color: '#000',
                        '-webkit-border-radius': '10px', // 確保容器有圓角
                        '-moz-border-radius': '10px'
                    },
                    overlayCSS: { backgroundColor: '#000', opacity: 0.6, cursor: 'wait' }
                });
                // 在 blockUI 顯示後，立即為其啟用 jQuery UI 的 draggable 功能
                // handle: '.custom-modal-title' 表示只有按住標題列時才能拖曳
                $('.blockMsg').draggable({
                    handle: ".custom-modal-title",
                    cursor: "move"
                });
                // 讓彈出視窗可以被使用者調整大小
                $('.blockMsg').resizable({
                    // 's' 代表 south (南方，即底部)，只允許垂直向下拉伸
                    handles: 's' 
                });
                // Bind the save event to the button
                $('#btnSaveOtherFees').on('click', saveOtherFees);
            }
            /**
             * 建立可編輯表單的 HTML
             */
            function buildEditableFeeFormHtml(values, keyVal, logs, titleText, selYearS, feeDescriptions) {
                
                // 如果有 log 才建立日誌表格，否則顯示空字串
                const logTableHtml = (logs && logs.length > 0) 
                    ? buildFeeLogTableHtml(logs, "其他費用", false, feeDescriptions) 
                    : '';

                return `
                    <div class="custom-modal-wrapper">
                        <div class="custom-modal-title">${titleText} ${selYearS} - 其他費用</div>
                        <div class="custom-modal-content">
                            <input type="hidden" id="feeKeyVal" value="${keyVal}">
                            <table class="fee-form-table">
                                <tbody>
                                    <tr>
                                        <td class="label-cell">清潔費:</td>
                                        <td><input type="number" size="10" id="txtCleanAmt" value="${values.CleanAmt || 0}" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">匯費:</td>
                                        <td><input type="number" size="10" id="txtRemitAmt" value="${values.RemitAmt || 0}" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label-cell">開工紅包:</td>
                                        <td><input type="number" size="10" id="txtBonusAmt" value="${values.BonusAmt || 0}" /></td>
                                    </tr>
                                </tbody>
                            </table>
                            <hr>
                            <div style="text-align:center;">
                                <input type="button" value="確定" id="btnSaveOtherFees">
                            </div>
                            <div class="log-table-container">
                                ${logTableHtml ? '<hr>' + logTableHtml : ''}
                            </div>
                        </div>
                    </div>
                `;                
            }            
            /**
             * ===== START: 修正後的 buildFeeLogTableHtml 函式 =====
             * 根據傳入的參數，動態產生不同格式的日誌表格
             */
            function buildFeeLogTableHtml(logs, displayNa, remarkFlag, colDesc) {
                if (!logs || logs.length === 0) {
                    return '<p style="text-align:center;">無修改紀錄</p>';
                }

                // 1. 根據 remarkFlag 決定標題的 colspan 和表頭欄位
                const colspan = remarkFlag ? '4' : '3';
                const remarkHeader = remarkFlag ? '<th>修改備註</th>' : '';
                const firstColumnHeader =  `<th>${displayNa}</th>` ;

                let tableHtml = `<table id="LogInfo" style="width:100%; font-size:12px;">
                    <thead>
                        <tr style="background-color:#f0f0f0;">
                            <th colspan="${colspan}">${displayNa} 歷程</th>
                        </tr>
                        <tr style="background-color:#f0f0f0;">
                            ${firstColumnHeader}
                            ${remarkHeader}
                            <th>修改人</th>
                            <th>修改時間</th>
                        </tr>
                    </thead>
                    <tbody>`;

                // 2. 判斷是否為多欄位模式
                const isMultiColumn = Object.keys(colDesc).length > 1;

                // 3. 根據條件產生每一筆紀錄的 <tr>
                logs.forEach(log => {
                    let firstCellContent = '';
                    if (remarkFlag) {
                        // 有備註欄模式，第一欄永遠只顯示值
                        firstCellContent = `<td>${log.columnVal || ''}</td>`;
                    } else {
                        // 無備註欄模式
                        if (isMultiColumn) {
                            // 多欄位，顯示 "中文名: 值"
                            const friendlyName = colDesc[log.ColumnNA] || log.ColumnNA;
                            firstCellContent = `<td>${friendlyName}: ${log.ColumnVal || ''}</td>`;
                        } else {
                            // 單欄位，只顯示值
                            firstCellContent = `<td>${log.ColumnVal || ''}</td>`;
                        }
                    }

                    const remarkCell = remarkFlag ? `<td>${log.Remark || ''}</td>` : '';

                    tableHtml += `<tr>
                                    ${firstCellContent}
                                    ${remarkCell}
                                    <td>${log.LogUser || ''}</td>
                                    <td>${log.Logdate || ''}</td>
                                  </tr>`;
                });

                tableHtml += '</tbody></table>';
                return tableHtml;
            }

            /**
             * 儲存修改後的其他費用
             */
            async function saveOtherFees() {
                const keyVal = $('#feeKeyVal').val();
                const userNum = getQueryParams().WebUser; // 從 Base.js 獲取

                const feeTypes = ['CleanAmt', 'RemitAmt', 'BonusAmt'];
                const logEntries = feeTypes.map(fee => ({
                    TableNA: "OtherAmt",
                    KeyVal: keyVal,
                    ColumnNA: fee,
                    ColumnVal: $(`#txt${fee}`).val() || '0',
                    LogID: userNum
                }));

                try {
                    const response = await fetch(`${SAVE_FEES_API_URL}?check=Y`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(logEntries)
                    });

                    if (!response.ok) throw new Error(`儲存失敗: ${response.status}`);
    
                    const result = await response.json();
                    alert(result.message || "儲存成功！");

                    $.unblockUI();
                    // 觸發主頁面查詢按鈕以重新整理資料
                    document.getElementById('filterForm').dispatchEvent(new Event('submit'));

                } catch (error) {
                    console.error("儲存其他費用失敗:", error);
                    alert("儲存失敗，請檢查網路連線或聯繫管理員。");
                }
            }
            /**
             * 產生「實際退佣金」儲存格的 HTML 內容與屬性
             * @param {object} row - 單筆案件資料
             * @param {string} displayAMT - 'Y' 或 'N'，決定是否顯示金額
             * @param {string} IsmisalignedSUM - 'Y' 或 'N'，判斷是否為當月補登
             * @param {number} act_service_amt - 已計算出的作業服務費
             * @returns {{html: string, numericValue: number}}
             */
            function generateActualCommissionCell(row, displayAMT, IsmisalignedSUM, act_service_amt) {
                let act_comm_amt = 0;
                let displayText = 'NA';
                let numericValueForTotal = 0;

                // 1. 權限檢查
                if (displayAMT === 'Y' && row.CaseType === 'sendcase') {
                    const isShinHsinProject = row.fund_company === 'FDCOM001' || row.project_title === 'PJ00099';

                    // 2. 根據專案類型區分邏輯
                    if (isShinHsinProject) {
                        // 新鑫專案邏輯
                        let base_comm_amt = (row.isCancel === 'N')
                            ? (Number(row.act_comm_amt) || 0)
                            : (Number(row.act_comm_amt_Cancel) || 0);

                        // 未確認的案件，要用預估佣金去減掉作業服務費
                        if (row.IsConfirm !== 'Y') {
                            act_comm_amt = (Number(row.Expe_comm_amt) || 0) - (act_service_amt || 0);
                        } else {
                            act_comm_amt = base_comm_amt;
                        }

                        //console.log(`[新鑫專案邏輯] act_comm_amt=${act_comm_amt}`);

                        // 當月補登的案件不顯示金額，只顯示 NA
                        if (IsmisalignedSUM === 'Y') {
                            displayText = 'NA';
                        } else {
                            displayText = formatNumber(act_comm_amt);
                        }
                    } else {
                        // 其他專案（如國興）的邏輯
                        act_comm_amt = (row.IsConfirm === 'Y')
                            ? (Number(row.act_comm_amt) || 0)
                            : (Number(row.Expe_comm_amt) || 0);
    
                        displayText = formatNumber(act_comm_amt);

                        // console.log(`[其他專案（如國興）的邏輯] act_comm_amt=${act_comm_amt}`);
                    }
   
                }

                // 只有「當月未齊件」的合計值為 0
                // 其他所有情況，包括「已取消」的案件，都使用上面計算出的 act_comm_amt (其本身已是正確的正值或負值)
                if (IsmisalignedSUM !== 'Y') {
                    numericValueForTotal = act_comm_amt;
                }
                // 產生 <td> 的屬性
                const attributes = `class="LogEDIT" data-logtable="House_sendcase" data-ubc="${row.U_BC}" data-displayna="實際退傭金" data-columna="act_comm_amt"`;
                //console.log(`<td ${attributes}>${displayText}</td>`);
                return {
                    html: `<td ${attributes}>${displayText}</td>`,
                    numericValue: numericValueForTotal,
                    displayText: displayText
                };
            }

            /**
             * ===== START: 新增 - 佣金與服務費儲存格產生器 =====
             * 根據單筆資料，一次性計算並產生「預估退佣金」和「作業服務費」兩個儲存格的完整 HTML 及數值
             * @param {object} row - 單筆案件資料
             * @param {string} displayAMT - 'Y' 或 'N'，決定是否顯示金額
             * @param {string} IsmisalignedSUM - 'Y' 或 'N'，判斷是否為當月補登
             * @param {string} selYearS - 當前查詢的年月
             * @param {number} index - 當前資料的索引
             * @returns {object} 包含兩個儲存格的資料和 HTML
             */
            function generateCommissionCells(row, displayAMT, IsmisalignedSUM, selYearS, index) {
                // --- 初始化回傳物件 ---
                const result = {
                    estimatedCommission: { attributes: '', displayText: 'NA', numericValue: 0 },
                    serviceFee: { attributes: '', displayText: 'NA', numericValue: 0 }
                };

                // 如果沒有權限，直接回傳預設值
                if (displayAMT !== 'Y') {
                    // 如果沒有權限，直接回傳一個包含空白<td>的html，以維持表格結構
                    result.estimatedCommission.html = `<td>${result.estimatedCommission.displayText}</td>`;
                    result.serviceFee.html = `<td>${result.serviceFee.displayText}</td>`;
                    return result;
                }

                // --- 1. 計算「預估退佣金」(Expe_comm_amt) ---
                let expe_comm_amt = 0;
                if (row.CaseType === 'sendcase') {
                    expe_comm_amt = (Number(row.Expe_comm_amt) || 0);
                }
    
                // 如果案件是已取消狀態，則將其值轉為正數
                if (row.isCancel === 'Y') {
                    expe_comm_amt = Math.abs(expe_comm_amt);
                }

                // 只在「當月未齊件」時將合計值設為 0
                if (IsmisalignedSUM === 'Y') {
                    result.estimatedCommission.numericValue = 0;
                } else {
                    result.estimatedCommission.numericValue = expe_comm_amt;
                }
    
                // 設定顯示文字
                result.estimatedCommission.displayText = (IsmisalignedSUM === 'Y') ? 'NA' : formatNumber(expe_comm_amt);
                if (row.CaseType !== 'sendcase') result.estimatedCommission.displayText = '0';

                // 如果案件已取消，或是在當月顯示的未齊件，則用於合計的數值為 0
                // if (row.isCancel === 'Y' || IsmisalignedSUM === 'Y') {
                //     result.estimatedCommission.numericValue = 0;
                // } else {
                //     result.estimatedCommission.numericValue = expe_comm_amt;
                // }
                // --- 2. 設定「預估退佣金」的點擊互動屬性 ---
                const estCommAttributes  = {};
                const isClickable = (row.U_BC !== "BC0900") && 
                    (
                        (row.isComm === "Y" && !row.misaligned_date) || 
                        (row.misaligned_date && row.Ismisaligned === "MisaMon") || // 校正大小寫
                        (row.isKF_CommRate === "Y")
                    );
                // 根據 ASP 邏輯組合 onclick 事件
                if (isClickable) {
                    estCommAttributes['class'] = 'commission-link'; // 加上樣式
                    estCommAttributes['data-hs-id'] = row.HS_id;
                    estCommAttributes['data-is-confirm'] = row.IsConfirm;
                    // 根據條件決定呼叫哪個函式
                    estCommAttributes['data-action'] = (row.isKF_CommRate === "Y") 
                        ? 'open-kf-comm-rate' 
                        : 'open-commission-rules';
                }
                result.estimatedCommission.attributes = Object.entries(estCommAttributes).map(([k, v]) => `${k}="${v}"`).join(' ');
                result.estimatedCommission.html = `<td ${result.estimatedCommission.attributes}>${result.estimatedCommission.displayText}</td>`;
                // --- 3. 計算「作業服務費」(act_service_amt) ---
                let act_service_amt = 0;
                let isPlus = "";
                let isSer = row.isSer;

                if (IsmisalignedSUM === 'N' && isSer === 'Y') {
                    const calculated_amt = expe_comm_amt * (Number(row.service_Rate) || 0);
                    act_service_amt = Math.ceil(calculated_amt);
                    if (act_service_amt != calculated_amt) {
                        isPlus = `${calculated_amt.toFixed(4)} --> ${act_service_amt}`;
                    }
                } else {
                    isSer = 'N';
                }

                if (isSer === 'Y' && row.IsConfirm === 'Y') {
                    act_service_amt = Number(row.act_service_amt) || 0;
                }
    
                // 在函式內部決定用於合計的數值
                // 根據舊 ASP 邏輯，作業服務費無論是否為未齊件，都會計入合計
                result.serviceFee.numericValue = act_service_amt;

                // --- 4. 設定「作業服務費」的顯示屬性與文字 ---
                const feeAttributes = {
                    'data-logtable': 'House_sendcase', 'data-ubc': row.U_BC, 'data-displayna': '作業服務費',
                    'data-columna': 'act_service_amt', 'data-rowidx': index, id: `tdact_service_amt${index}`
                };
    
                if (isSer === 'Y') {
                    feeAttributes.class = (isPlus && selYearS >= '2024-10') ? 'LogEDIT_P' : 'LogEDIT';
                    if (feeAttributes.class === 'LogEDIT_P') {
                        feeAttributes.title = isPlus;
                    }
                }
                if (row.IsConfirm === 'N') {
                    feeAttributes['data-init'] = 'Y';
                }
    
                result.serviceFee.attributes = Object.entries(feeAttributes).filter(([_, v]) => v).map(([k, v]) => `${k}="${v}"`).join(' ');
                result.serviceFee.displayText = (isSer === 'Y') ? formatNumber(act_service_amt) : 'NA';
                result.serviceFee.html = `<td ${result.serviceFee.attributes}>${result.serviceFee.displayText}</td>`;

                return result;
            }

            /**
             * 開啟國興專案的佣金參考視窗 (目前為佔位函式)
             * @param {string} hsId - 案件 ID
             * @param {string} isConfirm - 是否已確認 ('Y' or 'N')
             */
            function openKF_CommRate(hsId, isConfirm) {
                // TODO: 未來在此處實現獲取和顯示國興專案佣金的邏輯
                //alert(`此功能尚未開放：開啟國興佣金參考 (hsId: ${hsId})`);
                //console.log("Called openKF_CommRate with:", { hsId, isConfirm });
            }
            /**
             * exportToExcel 函式 =====
             */
            async function exportToExcel() {

                console.log("%c[偵錯] 7. exportToExcel - 開始執行，準備讀取 reportCache:", "color: purple; font-size: 14px;", reportCache);
                if (!reportCache || !Array.isArray(reportCache.data) || reportCache.data.length === 0) {
                    alert("沒有可匯出的資料，請先執行查詢。");
                    return;
                }

                // 1. 建立 Excel 工作簿和工作表
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('核准放款表');
                const currencyFormat = '#,##0';
                const footerFont = { color: { argb: 'FF0000FF' }, bold: true };
                const footerAlignRight = { horizontal: 'right' };
                const footerAlignLeft = { horizontal: 'left' };
                // 2. 定義表頭與欄位 (包含 key)
                worksheet.columns = [
                        { header: "No.", key: 'no' },
                        { header: "區", key: 'area' },
                        { header: "進件日", key: 'applyDate' },
                        { header: "申請人", key: 'applicant' },
                        { header: "介紹人", key: 'introducer' },
                        { header: "ID", key: 'introducerId' },
                        { header: "銀行名稱", key: 'bankName' },
                        { header: "銀行帳號", key: 'bankAccount' },
                        { header: "業務", key: 'sales' },
                        { header: "核准日", key: 'approveDate' },
                        { header: "核准金額(萬)", key: 'passAmount', style: { numFmt: currencyFormat } },
                        { header: "撥款日", key: 'disburseDate' },
                        { header: "撥款金額(萬)", key: 'disburseAmount', style: { numFmt: currencyFormat } },
                        { header: "專案", key: 'project' },
                        { header: "貸款成數(%)", key: 'ltv' }, // <--- key 在此定義
                        { header: "原始利率(%)", key: 'origRate' },
                        { header: "承作利率(%)", key: 'actualRate' },
                        { header: "收費", key: 'charge1', style: { numFmt: currencyFormat } },
                        { header: "代書費用", key: 'charge2', style: { numFmt: currencyFormat } },
                        { header: "對保費", key: 'charge3', style: { numFmt: currencyFormat } },
                        { header: "補貼代書費", key: 'subsidyAgent', style: { numFmt: currencyFormat } },
                        { header: "補貼過車費", key: 'subsidyFares', style: { numFmt: currencyFormat } },
                        { header: "結餘", key: 'balance', style: { numFmt: currencyFormat } },
                        { header: "補貼息", key: 'subsidyInterest', style: { numFmt: currencyFormat } },
                        { header: "退傭備註", key: 'commRemark' },
                        { header: "預估退佣金", key: 'estComm' },
                        { header: "作業服務費", key: 'serviceFee' },
                        { header: "實際退佣金", key: 'actualComm' },
                        { header: "委對/外對", key: 'comparison' },
                    ];
                // 3. 處理並加入資料列
                const dataForExport = reportCache.data.map((row, index) => {
                    const IsmisalignedSUM = (row.misaligned_date && row.Ismisaligned === 'ThisMon') ? 'Y' : 'N';
                    const commissionData = generateCommissionCells(row, displayAMT, IsmisalignedSUM, '', index);
                    const actualCommCell = generateActualCommissionCell(row, displayAMT, IsmisalignedSUM, commissionData.serviceFee.numericValue);
                    const commRemarkDisplay = (displayAMT === 'Y') ? row.Comm_Remark : 'NA';
                    return {
                        no: index + 1,
                        area: row.U_BC_name,
                        applyDate: row.Send_amount_date,
                        applicant: row.CS_name,
                        introducer: row.CS_introducer,
                        introducerId: row.Introducer_PID,
                        bankName: row.Bank_name,
                        bankAccount: String(row.Bank_account || ''),
                        sales: row.plan_name,
                        approveDate: row.Send_result_date,
                        passAmount: Number(row.pass_amount) || 0,
                        disburseDate: row.get_amount_date,
                        disburseAmount: Number(row.get_amount) || 0,
                        project: `${row.show_fund_company || ''}-${row.show_project_title || ''}`,
                        ltv: row.Loan_rate || '',
                        origRate: row.interest_rate_original || '',
                        actualRate: row.interest_rate_pass || '',
                        charge1: Number(row.charge_flow) || 0,
                        charge2: Number(row.charge_agent) || 0,
                        charge3: Number(row.charge_check) || 0,
                        subsidyAgent: Number(row.Subsidy_agent) || 0,
                        subsidyFares: Number(row.Subsidy_amt) || 0,
                        balance: Number(row.get_amount_final) || 0,
                        subsidyInterest: Number(row.subsidized_interest) || 0,
                        commRemark: commRemarkDisplay,
                        estComm: commissionData.estimatedCommission.displayText,
                        serviceFee: commissionData.serviceFee.displayText,
                        actualComm: actualCommCell.displayText,
                        comparison: row.Comparison
                    };
                });
                worksheet.addRows(dataForExport);

                // 4.1 其他費用列
                let footerRows = [];
                if (reportCache.totalOtherAmount > 0) {
                    const otherFeesRow = worksheet.addRow({
                        subsidyFares: '其他費用:',
                        balance: -reportCache.totalOtherAmount
                    });
                    footerRows.push(otherFeesRow);
                }
                // 4.2 總合計列
                const totalRow = worksheet.addRow({
                    no: `總筆數: ${reportCache.data.length}`,
                    disburseDate: '合計:',
                    disburseAmount: reportCache.totals.get_amount,
                    charge1: reportCache.totals.charge_flow,
                    charge2: reportCache.totals.charge_agent,
                    charge3: reportCache.totals.charge_check,
                    subsidyAgent: reportCache.totals.Subsidy_agent,
                    subsidyFares: reportCache.totals.Subsidy_amt,
                    balance: reportCache.totals.get_amount_final,
                    subsidyInterest: reportCache.totals.subsidized_interest,
                    estComm: reportCache.totals.Expe_comm_amt,
                    serviceFee: reportCache.totals.act_service_amt,
                    actualComm: reportCache.totals.act_comm_amt,
                });                
                footerRows.push(totalRow);
                // 4.3 未齊件合計列
                if (reportCache.misalignedCount > 0) {
                    // 步驟 1: 建立一個與表頭等長的空陣列範本
                    const misalignedRow = worksheet.addRow({
                        no: `未齊件筆數: ${reportCache.misalignedCount}`,
                        disburseDate: '未齊件合計:',
                        disburseAmount: `${reportCache.misalignedTotals.get_amount}萬`,
                        charge1: reportCache.misalignedTotals.charge_flow,
                        charge2: reportCache.misalignedTotals.charge_agent,
                        charge3: reportCache.misalignedTotals.charge_check,
                        subsidyAgent: reportCache.misalignedTotals.Subsidy_agent,
                        subsidyFares: reportCache.misalignedTotals.Subsidy_amt,
                        balance: reportCache.misalignedTotals.get_amount_final,
                        subsidyInterest: reportCache.misalignedTotals.subsidized_interest,
                        estComm: reportCache.misalignedTotals.Expe_comm_amt,
                        serviceFee: reportCache.misalignedTotals.act_service_amt,
                        actualComm: reportCache.misalignedTotals.act_comm_amt,
                    });
                    footerRows.push(misalignedRow);
                }

                // --- 5. 統一處理排版與樣式 ---
                //自動欄寬計算
                worksheet.columns.forEach(column => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell, rowNumber) => {
                        // 檢查是否為表尾的合併儲存格，如果是，則不納入計算
                        const isMergedFooterCell = (cell.isMerged && rowNumber > (1 + reportCache.data.length));
            
                        if (!isMergedFooterCell && cell.value) {
                            const length = getCellVisualWidth(cell.value);
                            if (length > maxLength) {
                                maxLength = length;
                            }
                        }
                    });
                    column.width = maxLength < 10 ? 12 : maxLength + 4;
                });

                // --- 6. 統一處理表尾的合併與樣式 ---
                const footerStartIndex = 1 + reportCache.data.length+1; // 表頭+資料
                for (let i = footerStartIndex; i <= worksheet.lastRow.number; i++) {
                    const row = worksheet.getRow(i);
                    if (!row.hasValues) continue;

                    // 設定統一的藍色字體、靠右對齊和數字格式
                    row.eachCell({ includeEmpty: false }, cell => {
                        cell.font = footerFont;
                        cell.alignment = footerAlignRight;
                        if (typeof cell.value === 'number') {
                            cell.numFmt = currencyFormat;
                        }
                    });

                    if (String(row.getCell('no').value).includes('筆數')) {
                        worksheet.mergeCells(i, 1, i, 5);
                        worksheet.mergeCells(i, 6, i, 11);
                        row.getCell('no').alignment = footerAlignLeft;
                        row.getCell('disburseDate').alignment = footerAlignLeft;
                    }
                }                
                // 7.排版與樣式設定區塊
                // ===== START: 核心修正 - 恢復最精準的最適欄寬計算 =====
    
                // **步驟 A: 識別哪些欄位在表尾是合併儲存格**
                const mergedFooterColumnKeys = ['no', 'area', 'applyDate', 'applicant', 'introducer', 'introducerId', 'bankName', 'bankAccount', 'sales', 'approveDate', 'passAmount'];

                // **步驟 B: 執行混合式計算**
                worksheet.columns.forEach(column => {
                    let dataToCalculate;
                    let maxLength = 0;

                    // --- 準備用於偵錯的資料 ---
                    const headerValue = column.header;
                    const bodyValues = reportCache.data.map(row => {
                    const index = reportCache.data.indexOf(row);
                    // 這個 switch 語句將欄位別名(key)對應到它實際的資料屬性
                    switch (column.key) {
                        case 'no': return index + 1;
                        case 'area': return row.U_BC_name;
                        case 'applyDate': return row.Send_amount_date;
                        case 'applicant': return row.CS_name;
                        case 'introducer': return row.CS_introducer;
                        case 'introducerId': return row.Introducer_PID;
                        case 'bankName': return row.Bank_name;
                        case 'bankAccount': return String(row.Bank_account || '');
                        case 'sales': return row.plan_name;
                        case 'approveDate': return row.Send_result_date;
                        case 'passAmount': return Number(row.pass_amount) || 0;
                        case 'disburseDate': return row.get_amount_date;
                        case 'disburseAmount': return Number(row.get_amount) || 0;
                        case 'project': return `${row.show_fund_company || ''}-${row.show_project_title || ''}`;
                        case 'ltv': return row.Loan_rate || '';
                        case 'origRate': return row.interest_rate_original || '';
                        case 'actualRate': return row.interest_rate_pass || '';
                        case 'charge1': return Number(row.charge_flow) || 0;
                        case 'charge2': return Number(row.charge_agent) || 0;
                        case 'charge3': return Number(row.charge_check) || 0;
                        case 'subsidyAgent': return Number(row.Subsidy_agent) || 0;
                        case 'subsidyFares': return Number(row.Subsidy_amt) || 0;
                        case 'balance': return Number(row.get_amount_final) || 0;
                        case 'subsidyInterest': return Number(row.subsidized_interest) || 0;
                        case 'commRemark':
                            const commRemarkDisplay = (displayAMT === 'Y') ? row.Comm_Remark : 'NA';
                            return commRemarkDisplay;
                        case 'estComm':
                        case 'serviceFee':
                        case 'actualComm':
                            // 對於需要計算的欄位，重新呼叫計算函式
                            const IsmisalignedSUM = (row.misaligned_date && row.Ismisaligned === 'ThisMon') ? 'Y' : 'N';
                            const commissionData = generateCommissionCells(row, displayAMT, IsmisalignedSUM, '', index);
                            if (column.key === 'estComm') return commissionData.estimatedCommission.displayText;
                            if (column.key === 'serviceFee') return commissionData.serviceFee.displayText;
            
                            const actualCommCell = generateActualCommissionCell(row, displayAMT, IsmisalignedSUM, commissionData.serviceFee.numericValue);
                            return actualCommCell.displayText;
                        case 'comparison': return row.Comparison;
                        default: return undefined;
                    }
                });
    
                    // 從 worksheet 中提取表尾的值
                    const footerStartIndex = 1 + reportCache.data.length + 1; // 表頭+資料+空行
                    let footerValues = [];
                    for (let i = footerStartIndex; i <= worksheet.lastRow.number; i++) {
                        const row = worksheet.getRow(i);
                        // 使用 getCell 並傳入欄位的 key 來獲取儲存格
                        footerValues.push(row.getCell(column.key).value);
                    }

                    // --- 執行規則判斷 ---
                    // 規則 3: 如果該欄的 key 在我們的合併欄位清單中，則只比較表頭和表身
                    if (mergedFooterColumnKeys.includes(column.key)) {
                        dataToCalculate = [headerValue, ...bodyValues];
                        const lengths = dataToCalculate.map(cell => getCellVisualWidth(cell));
                        maxLength = Math.max(0, ...lengths);

                        // **偵錯日誌**
                        console.groupCollapsed(`欄位: ${headerValue} [規則3 - 排除表尾合併]`);
                        console.log("表頭:", headerValue, `(寬度: ${getCellVisualWidth(headerValue)})`);
                        console.log("表身內容:", bodyValues);
                        console.log("表身最大寬度:", Math.max(0, ...bodyValues.map(v => getCellVisualWidth(v))));
                        console.log(`最終計算寬度 (無緩衝): ${maxLength}`);
                        console.groupEnd();

                    } 
                    // 規則 1 & 2: 否則，比較表頭、表身和表尾所有內容
                    else {
                        dataToCalculate = [headerValue, ...bodyValues, ...footerValues];
                        const lengths = dataToCalculate.map(cell => getCellVisualWidth(cell));
                        maxLength = Math.max(0, ...lengths);

                        // **偵錯日誌**
                        console.groupCollapsed(`欄位: ${headerValue} [規則1 - 包含所有]`);
                        console.log("表頭:", headerValue, `(寬度: ${getCellVisualWidth(headerValue)})`);
                        console.log("表身內容:", bodyValues);
                        console.log("表身最大寬度:", Math.max(0, ...bodyValues.map(v => getCellVisualWidth(v))));
                        console.log("表尾內容:", footerValues);
                        console.log("表尾最大寬度:", Math.max(0, ...footerValues.map(v => getCellVisualWidth(v))));
                        console.log(`最終計算寬度 (無緩衝): ${maxLength}`);
                        console.groupEnd();
                    }

                    column.width = maxLength + 4;
                });

                // 7.2.設定指定欄位的內容靠右對齊**
                const colsToAlignRight = ['ltv', 'origRate', 'actualRate', 'estComm', 'serviceFee', 'actualComm'];
                colsToAlignRight.forEach(key => {
                    const col = worksheet.getColumn(key);
                    if (col) {
                        col.alignment = { horizontal: 'right' };
                    }
                });                

                // 8. 產生 buffer 並觸發下載
                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `核准放款表_佣金表-${getFormattedDate()}.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
            }            

            function getFormattedDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            }
            /**
             * 計算儲存格視覺寬度的輔助函式 =====
             * @param {string} value - 要計算的儲存格文字
             * @returns {number} - 考慮到中文字為雙倍寬度的視覺寬度
             */
            function getCellVisualWidth(value) {
                const strValue = String(value || '');
                let width = 0;
                for (let i = 0; i < strValue.length; i++) {
                    // 使用正規表示式判斷是否為全形字元 (包括中、日、韓文等)
                    if (/[^\x00-\xff]/.test(strValue[i])) {
                        width += 2; // 全形字元算 2 個寬度
                    } else {
                        width += 1; // 半形字元算 1 個寬度
                    }
                }
                return width;
            }


            // 頁面初始化主流程 (使用 async/await) =====
            async function main() {
                try {
                    // 步驟 1: 從 Base.js 獲取使用者基本資訊
                    const URLParams = getQueryParams();
                    const userNum = URLParams.WebUser;
                    userBC = URLParams.WebBC; // 獲取分公司代碼

                    // 使用 Promise.all 並行處理非同步任務，提升載入速度
                    const [currentUserRoleNum] = await Promise.all([
                        fetchRoleNum(userNum),           // 任務1: 獲取角色 (會回傳角色代碼)
                        populateBranchDropdown(userBC),  // 任務2: 填充分公司選單 (不需回傳值)
                        populateMonthDropdown()          // 任務3: 填充撥款年月選單 (不需回傳值)
                    ]);
                    setDefaultMonth(); // 在所有下拉選單都填充完畢後，才設定預設值
                    // 步驟 2: 根據角色和其他權限，設定 UI
                    currentUserAuth = getAuth(currentUserRoleNum);

                    // 計算權限標籤
                    if (currentUserAuth === 'Asi' && !['BC0100', 'BC0200', 'BC0400', 'BC0500'].includes(userBC)) {
                        displayAMT = 'N';
                    }
                    // 計算 isEditOtherFee
                    if (['Man', 'Asi', 'Adm'].includes(currentUserAuth)) {
                        isEditOtherFee = true;
                    }

                    // 步驟 3: 根據權限設定 UI
                    initializeUI(currentUserAuth);

                    // 步驟 4: UI 設定完成後，觸發第一次資料查詢
                    form.dispatchEvent(new Event('submit'));

                } catch (error) {
                    console.error("頁面初始化失敗:", error);
                    alert("頁面初始化過程中發生錯誤，請聯絡管理員。");
                }
            }
            // 執行初始化主流程(觸發第一次查詢)
            main();
            
        });
</script >