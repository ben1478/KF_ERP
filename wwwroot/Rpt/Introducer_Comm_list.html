<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>介紹人佣金管理</title>
    <link href="../_include/main.css" rel="stylesheet" type="text/css">
    <script src="../Base.js"></script>
    <style>
        .btn {
            background-color: #f0f0f0;
            border: 1px solid #767676;
            border-radius: 3px;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: #000000;
        }

        .btn:hover {
            background-color: #e5e5e5;
        }

        .btn:focus, .btn:active {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 1px #000000;
        }

        .action-icon {
            cursor: pointer;
            width: 16px;
            height: 18px;
            vertical-align: middle;
        }

        #data-table-body td {
            padding: 8px;
            vertical-align: middle;
        }

        .c12-k {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td width="20">　</td>
            <td width="230" height="24" background="../../image/title-bk.gif">
                <span class="c14k"><strong>介紹人佣金管理</strong></span>
            </td>
            <td></td>
        </tr>
        <tr>
            <td>　</td>
            <td colspan="2">
                <table border="0" width="100%" id="table1" style="margin-top: 10px;">
                    <tr class="c12-k">
                        <td>
                            介紹人：
                            <input type="text" id="introducer" name="introducer" size="12" class="c12-k">(模糊比對)　
                            公司行號/自營商：
                            <select name="isCompany" id="isCompany" class="c12-k">
                                <option value="">全部</option>
                                <option value="Y">公司/自營商</option>
                                <option value="N">個人</option>
                            </select>
                            <input type="button" name="query" class="btn" value="查詢" onclick="refreshData()">
                            <input type="button" value="匯出Excel" name="btnExcel" class="btn" onclick="exportToExcel()">
                        </td>
                        <td align="right">
                            <input type="button" name="add" value="新增介紹人" class="btn" onclick="openDetail('add')">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: 15px;">
        <tr>
            <td valign="top">　</td>
            <td align="center" valign="top">
                <table id="MainTable" width="1300" border="0" cellpadding="4" cellspacing="1" bgcolor="#666666">
                    <thead>
                        <tr align="center" bgcolor="#CCCCFF" class="c12-k">
                            <td width="50">序號</td>
                            <td width="100">介紹人</td>
                            <td width="100">生日</td>
                            <td width="120">身分證/統編</td>
                            <td width="150">收款帳號</td>
                            <td width="120">收款總行</td>
                            <td width="120">收款分行</td>
                            <td width="120">收款銀行</td>
                            <td>地址</td>
                            <td width="150">備註</td>
                            <td width="40">修改</td>
                            <td width="40">刪除</td>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                    </tbody>
                </table>
            </td>
        </tr>
    </table>

    <script>
        // 取得登入使用者資訊
        const { WebUser } = getQueryParams();

        // ====================【核心修改：將 refreshData 移至全域範疇】====================
        /**
         * 核心函數：根據篩選條件從 API 獲取資料並重繪表格
         * 因為需要被彈出視窗 (window.opener) 呼叫，此函數必須定義在全域範疇。
         */
        function refreshData() {
            const introducerName = document.getElementById('introducer').value;
            const isCompany = document.getElementById('isCompany').value;
            const tableBody = document.getElementById('data-table-body');

            tableBody.innerHTML = '<tr><td colspan="12" align="center">資料載入中...</td></tr>';

            const requestBody = {
                Introducer: introducerName,
                isCompany: isCompany
            };

            fetch(`${BASE_URL}/AE_RPT/Introducer_Comm_LQuery`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.resultMsg || '伺服器錯誤') });
                return response.json();
            })
            .then(data => {
                tableBody.innerHTML = ''; // 清空表格
                if (data.resultCode === '000') {
                    const results = JSON.parse(data.objResult);
                    if (results.length === 0) {
                         tableBody.innerHTML = '<tr><td colspan="12" align="center">查無資料</td></tr>';
                         return;
                    }
                    results.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.align = 'center';
                        row.className = 'c12-k';
                        row.style.backgroundColor = '#FFFFFF';
                        row.onmouseover = function() { this.style.backgroundColor = '#FCFCC0'; };
                        row.onmouseout = function() { this.style.backgroundColor = '#FFFFFF'; };

                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.Introducer_name || ''}</td>
                            <td>${item.Introducer_HBD || ''}</td>
                            <td>${item.Introducer_PID || ''}</td>
                            <td>${item.Bank_account || ''}</td>
                            <td>${item.Bank_head || ''}</td>
                            <td>${item.Bank_branches || ''}</td>
                            <td>${item.Bank_name || ''}</td>
                            <td align="left">${item.Introducer_addr || ''}</td>
                            <td align="left">${item.Remark || ''}</td>
                            <td><img src="../images/edit.png" class="action-icon" alt="修改" onclick="openDetail('${item.U_ID}')"></td>
                            <td><img src="../images/delete.png" class="action-icon" alt="刪除" onclick="deleteItem('${item.U_ID}', '${item.Introducer_name}')"></td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                     tableBody.innerHTML = `<tr><td colspan="12" align="center">查詢失敗: ${data.resultMsg}</td></tr>`;
                }
            })
            .catch(error => {
                console.error('查詢失敗:', error);
                tableBody.innerHTML = `<tr><td colspan="12" align="center">查詢失敗: ${error.message}</td></tr>`;
            });
        }

        // 頁面載入完成後，執行第一次查詢
        document.addEventListener('DOMContentLoaded', function() {
            if (WebUser) {
                refreshData();
            } else {
                document.getElementById('data-table-body').innerHTML = '<tr><td colspan="12" align="center">無法獲取使用者資訊，請重新登入。</td></tr>';
            }
        });

        function openDetail(id) {
            const encryptedId = encryptParameter(id);
            const encryptedUser = encryptParameter(WebUser || 'Sys');
            const url = `Introducer_Comm_Detail.html?Id=${encryptedId}&User=${encryptedUser}`;
            window.open(url, '_blank', 'scrollbars=yes,resizable=yes,width=800,height=500,left=250,top=100');
        }

        function deleteItem(u_id, name) {
            if (!confirm(`確定要刪除介紹人「${name}」的資料嗎？`)) return;

            const requestBody = { U_ID: u_id, del_num: WebUser || 'Sys' };

            fetch(`${BASE_URL}/AE_RPT/Introducer_Comm_DetDel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.resultMsg || '伺服器錯誤') });
                return response.json();
            })
            .then(data => {
                if (data.resultCode === '000') {
                    alert('刪除成功！');
                    refreshData();
                } else {
                    alert(`刪除失敗: ${data.resultMsg}`);
                }
            })
            .catch(error => {
                console.error('刪除時發生錯誤:', error);
                alert(`刪除失敗: ${error.message}`);
            });
        }

        function exportToExcel() {
            const introducerName = document.getElementById('introducer').value;
            const isCompany = document.getElementById('isCompany').value;

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `${BASE_URL}/AE_RPT/Introducer_Comm_Exccel`;

            const introducerInput = document.createElement('input');
            introducerInput.type = 'hidden';
            introducerInput.name = 'Introducer';
            introducerInput.value = introducerName;
            form.appendChild(introducerInput);

            const isCompanyInput = document.createElement('input');
            isCompanyInput.type = 'hidden';
            isCompanyInput.name = 'isCompany';
            isCompanyInput.value = isCompany;
            form.appendChild(isCompanyInput);

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
    </script>

</body>
</html>