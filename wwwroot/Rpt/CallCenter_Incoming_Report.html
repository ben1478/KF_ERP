<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/tool_js/Jquery.js"></script>
    <link href="/tool_js/jqplot/css/jquery.jqplot.min.css" rel="stylesheet" />
    <script type="text/javascript" src="/tool_js/jqplot/js/jquery.jqplot.js?1=fgr"></script>
    <script type="text/javascript" src="/tool_js/jqplot/js/jqplot.barRenderer.js"></script>
    <script type="text/javascript" src="/tool_js/jqplot/js/jqplot.pieRenderer.js?11=1458"></script>
    <script type="text/javascript" src="/tool_js/jqplot/plugins/jqplot.canvasTextRenderer.js"></script>
    <script type="text/javascript" src="/tool_js/jqplot/js/jqplot.categoryAxisRenderer.js"></script>
    <script type="text/javascript" src="/tool_js/jqplot/plugins/jqplot.canvasAxisTickRenderer.js"></script>
    <script type="text/javascript" src="/tool_js/jqplot/js/jqplot.pointLabels.js"></script>
    <script type="text/javascript" src="/tool_js/jqplot/js/jqplot.highlighter.js?1=2"></script>
    <script type="text/javascript" src="../tool_js/jquery.blockUI.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="../Base.js"></script>
</head>
<body>
    <table border="0" width="100%" style="padding-left:25px;">
        <tbody>
            <tr class="c12-k">
                <td width="86%">
                    <label>詢問:</label><select name="TelAsk" id="TelAsk" class=""></select>
                    <label>來源:</label><select name="TelSour" id="TelSour" class=""></select>
                    <label>狀態:</label><select name="fin_type" id="fin_type" class=""></select>
                    <label>單位:</label>
                    <select name="timeGranularity" id="timeGranularity" class="">
                        <option value="30" selected>半小時</option>
                        <option value="60">1小時</option>
                    </select>
                    <input type="text" value="" name="checkDateS" class="datepickerTW" placeholder="年 /月 /日" style="width:80px;">~
                    <input type="text" value="" name="checkDateE" class="datepickerTW" placeholder="年 /月 /日" style="width:80px;">
                    <input type="button" value="查詢" onclick="fetchData();" />
                </td>
            </tr>
        </tbody>
    </table>
    <br />
    <div id="chartContainer">
        <div id="chart1" style="height:400px; width:100%;"></div>
    </div>
</body>
</html>
<script>
    let data = []; 

    dateTW();
    loadItemDropdown({
        selectId: "TelAsk",
        itemCode: "TelAsk"
    });
    loadItemDropdown({
        selectId: "TelSour",
        itemCode: "TelSour"
    });
    loadItemDropdown({
        selectId: "fin_type",
        itemCode: "fin_type"
    });
    
    $('.datepickerTW').datepickerTW({
        changeYear: true,
        changeMonth: true,
        dateFormat: 'yy-mm-dd'
    });

    convertToTaiwanDate();
    function convertToTaiwanDate() {
        var currentDate = new Date();
        var westernYear = currentDate.getFullYear();
        var taiwanYear = westernYear - 1911;
        var month = currentDate.getMonth() + 1;
        var day = currentDate.getDate();
        var formattedDate = taiwanYear + '-' + (month < 10 ? '0' + month : month) + '-' + (day < 10 ? '0' + day : day);
        document.querySelector('input[name="checkDateE"]').value = formattedDate;
        document.querySelector('input[name="checkDateS"]').value = '115-01-01'
    }
   

    // 轉分鐘
    function timeToMinutes(t) {
        let [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    }

    // 生成半小時區間刻度
    function generateHalfHourTicks() {
        let ticks = [];
        for (let h = 0; h < 24; h++) {
            let hh = h.toString().padStart(2, '0');
            ticks.push(`${hh}:00~${hh}:30`);
            ticks.push(`${hh}:30~${(h + 1).toString().padStart(2, '0')}:00`);
        }
        return ticks;
    }

    // 生成一小時區間刻度
    function generateHourTicks() {
        let ticks = [];
        for (let h = 0; h < 24; h++) {
            ticks.push(
                `${h.toString().padStart(2, '0')}:00~${(h + 1)
                    .toString()
                    .padStart(2, '0')}:00`
            );
        }
        return ticks;
    }

    // 將資料對齊到區間
    function alignDataToTicks(rawData, granularity) {
        let dataArr = JSON.parse(rawData);
        let ticks = granularity === 30 ? generateHalfHourTicks() : generateHourTicks();
        let counts = new Array(ticks.length).fill(0);
        dataArr.forEach(item => {
            let tMin = timeToMinutes(item.InTime);
            let count = Math.round(Number(item.Count)) || 0;

            for (let i = 0; i < ticks.length; i++) {
                let [start, end] = ticks[i].split('~');
                let startMin = timeToMinutes(start);
                let endMin = timeToMinutes(end);

                if (tMin >= startMin && tMin < endMin) {
                    counts[i] += count;
                    break;
                }
            }
        });
        counts = counts.map(c => Math.round(c));

        return { counts, ticks };
    }


    // 畫圖
    function drawChart(counts, ticks) {
        $.jqplot('chart1', [counts], {
            seriesDefaults: {
                renderer: $.jqplot.BarRenderer,
                rendererOptions: { fillToZero: true },
                pointLabels: {
                    show: true,
                    formatString: '%d'
                }
            },
            axes: {
                xaxis: {
                    renderer: $.jqplot.CategoryAxisRenderer,
                    ticks: ticks,
                    label: '初次來電時間',
                    tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                    tickOptions: {
                        angle: -60,
                        fontSize: '10pt',
                        showGridline: false,
                        mark: 'outside',
                        show: true
                    }
                },
                yaxis: {
                    min: 0,
                    label: '來電數量',
                    max: Math.max(...counts) + 100
                }
            },
            highlighter: {
                show: true,
                showMarker: true,
                tooltipContentEditor: function (str, seriesIndex, pointIndex) {
                    return ticks[pointIndex] + ' ： ' + Math.round(counts[pointIndex]); 
                }
            }
        });
    }


    // fetch 資料
    function fetchData() {
        const parts_S = document.querySelector('input[name="checkDateS"]').value.split('-');
        const taiwanYear_S = parseInt(parts_S[0], 10);
        const month_S = parseInt(parts_S[1], 10);
        const day_S = parseInt(parts_S[2], 10);

        const parts_E = document.querySelector('input[name="checkDateE"]').value.split('-');
        const taiwanYear_E = parseInt(parts_E[0], 10);
        const month_E = parseInt(parts_E[1], 10);
        const day_E = parseInt(parts_E[2], 10);

        const westernYear_S = taiwanYear_S + 1911;
        const yyyymmdd_S = `${westernYear_S}-${String(month_S).padStart(2, '0')}-${String(day_S).padStart(2, '0')}`;

        const westernYear_E = taiwanYear_E + 1911;
        const yyyymmdd_E = `${westernYear_E}-${String(month_E).padStart(2, '0')}-${String(day_E).padStart(2, '0')}`;

        let model = {
            TelAsk: document.getElementById('TelAsk')?.value || '',
            TelSour: document.getElementById('TelSour')?.value || '',
            Fin_type: document.getElementById('fin_type')?.value || '',
            checkDateS: yyyymmdd_S,
            checkDateE: yyyymmdd_E
        };

        const granularity = parseInt(document.getElementById('timeGranularity').value);
        const url = `${BASE_URL}/AE_RPT/GetIncoming`;

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(model)
        })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.resultCode === "000") {
                    clearChart();
                    const { counts, ticks } = alignDataToTicks(
                        responseData.objResult,
                        granularity
                    );
                    drawChart(counts, ticks);
                } else {
                    alert(responseData.resultMsg);
                }
            })
            .catch(error => {
                alert('API 請求失敗: ' + error);
            });
    }

    function clearChart() {
        $('#chart1').empty();
        //$('#chart1').remove(); // 連同 jqPlot 外層 X/Y 軸 DOM 一起清掉

        // 重新建立新的 chart1
        $('#chartContainer').append(
            '<div id="chart1" style="height:400px; width:100%;"></div>'
        );
    }
</script>