<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>簽核平台</title>

    <!-- jQuery + jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <script src="../Base.js"></script>

    <!-- RWD CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background-color: #f9f9f9;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .section-title {
            background-color: #CCCCFF;
            padding: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 10px 0;
            background: #fff;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

            .form-row label {
                flex: 0 0 120px;
                text-align: right;
                margin-right: 10px;
            }

            .form-row .input-area {
                flex: 1 1 auto;
                min-width: 200px; /* 或依照你欄位內容調整 */
            }

        textarea, input[type="text"], input[type="radio"] {
            width: 100%;
            max-width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        .radio-group input {
            width: auto;
            margin-right: 5px;
        }

        .center-btn {
            text-align: center;
            padding: 15px 0;
        }

        .btn {
            padding: 8px 20px;
            font-size: 1em;
        }

        iframe {
            width: 100%;
            height: 600px;
            border: none;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
            }

                .form-row label {
                    text-align: left;
                    margin-bottom: 5px;
                }

                .form-row .input-area {
                    width: 100%;
                    min-width: unset;
                }
        }

        table#FlowTable {
            width: 100%;
            background-color: #6666ff;
        }

            table#FlowTable td {
                padding: 5px;
                text-align: center;
            }

        table#counterTable {
            width: 100%;
            margin-top: 15px;
            background-color: #666;
        }

            table#counterTable td {
                background-color: #fff;
                padding: 10px;
            }

        iframe {
            width: 100%;
            height: 600px; 
            border: none;
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="section-title">簽核</div>

        <div class="form-row">
            <label>簽核流程</label>
            <div class="input-area">
                <table id="FlowTable"><tbody></tbody></table>
            </div>
        </div>

        <div class="form-row">
            <label>簽核結果</label>
            <div class="input-area radio-group">
                <input type="radio" name="FD_Step_SignType" value="FSIGN001" checked>簽核中
                <input type="radio" name="FD_Step_SignType" value="FSIGN002">同意
                <input type="radio" name="FD_Step_SignType" value="FSIGN003">不同意
            </div>
        </div>

        <div class="form-row">
            <label>簽核說明</label>
            <div class="input-area">
                <textarea name="FD_Step_desc" rows="3"></textarea>
            </div>
        </div>

        <div class="form-row">
            <label>是否需要會簽</label>
            <div class="input-area">
                <input type="button" value="選擇會簽人員" onclick="countersignPeople();" id="btencounter" />
                <div style="color:red; margin-top:5px;">一旦選擇會簽人員後 須等會簽完畢後才可審核</div>
            </div>
        </div>

        <div class="center-btn">
            <input type="button" class="btn" value="確定簽核" onclick="reviewData();" id="btnReview" />
        </div>

        <!-- 會簽區塊 -->
        <table id="counterTable" style="display:none;">
            <thead>
                <tr align="center" bgcolor="#CCCCFF" height="30">
                    <td class="c12-k" colspan="2"><b><font size="3">會簽</font></b></td>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <iframe id="myIframe" style="width:100%; min-height:600px; border:none;"></iframe>
    </div>
</body>
</html>
<script>
    let Params = new URLSearchParams(window.location.search);
    let encodedPath = Params.get("path");
    let encodedForm_ID = Params.get("Form_ID");
    let encryptedUser = Params.get("User");
    let path = decodeURIComponent(encodedPath);

   

    let AF_ID;
    let FM_Step;
    let FM_Source_ID = decryptParameter(encodedForm_ID);
    let data = [];

    getIframeSource(path);
    fetchData();

    function getIframeSource(path) {
        var iframe = document.getElementById("myIframe");
        console.log(iframe + path);
        iframe.src = BASE_WEB + path;
        
    }

    function fetchData() {
        const url = `${BASE_URL}/AE_AF/RevFlow_SQuery?FormID=${FM_Source_ID}`;

        fetch(url, {
            method: 'GET'
        })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.resultCode == "000") {
                    data = JSON.parse(responseData.objResult);
                    AF_ID = data[0].AF_ID;
                    FM_Step = data[0].FM_Step;

                    const countersignData = data.filter(item => item.FD_Sign_Countersign === 'C');
                    if (countersignData.length > 0) {
                        const counter = countersignData.filter(item => decryptParameter(encryptedUser) === item.FD_Step_num);
                        const counterTable = document.querySelector('#counterTable tbody');
                        let tableHTML = '';

                        if (counter.length > 0) {
                            counter.forEach(item => {
                                tableHTML += `
                                    <tr class="c12-k" bgcolor="#FFFFFF">
                                        <td align="right">會簽意見</td>
                                        <td colspan="1">
                                            <textarea rows="2" cols="60" name="C_FD_Step_desc">${item.FD_Step_desc}</textarea>
                                        </td>
                                    </tr>
                                    <tr align="center" bgcolor="#CCCCFF">
                                        <td class="c12-k" colspan="2">
                                            <input type="hidden" name="C_FM_Source_ID" value="${item.FM_Source_ID}">
                                            <input type="hidden" name="C_FD_Step_num" value="${item.FD_Step_num}">
                                            <input type="button" class="btn" value="送出意見" onclick="counterData();" id="btnCounter">
                                        </td>
                                    </tr>
                                `;
                            });
                            document.querySelector('#btnReview').setAttribute('disabled', true);
                            document.querySelector('#btencounter').setAttribute('disabled', true);
                        } else {
                            countersignData.forEach(item => {
                                tableHTML += `
                                    <tr class="c12-k" bgcolor="#FFFFFF">
                                        <td align="right"><span>${item.U_name}</span></td>
                                        <td colspan="1">
                                            <textarea rows="2" cols="60" name="C_FD_Step_desc" readonly>${item.FD_Step_desc}</textarea>
                                        </td>
                                    </tr>

                                `;
                            });
                        }

                        counterTable.innerHTML = tableHTML;

                        const countersignTable = document.querySelector('#counterTable');
                        if (countersignTable) {
                            countersignTable.style.display = '';
                        }

                    }

                    FlowShow();
                }
            })
            .catch(error => {
                alert('API 請求失敗:', error);
            });
    }

    function FlowShow() {
        const url = `${BASE_URL}/AE_AF/RevFlow_Query?FormID=${decryptParameter(encodedForm_ID)}`;
        const flowTable = document.querySelector('#FlowTable tbody');
        flowTable.innerHTML = '<span>載入中...</span>';

        fetch(url, {
            method: 'GET'
        })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.resultCode === '000') {
                    const objResult = JSON.parse(responseData.objResult);
                    let tableHTML = `
                    <tr bgcolor="#E2F1F7" height="25" class="c12-k" align="center">
                `;
                    objResult.forEach(item => {
                        const title = item.FD_Step_title;
                        const bgcolor = (FM_Step === item.FD_Step) ? '#E2CCF7' : '';
                        tableHTML += `<td width="120" bgcolor="${bgcolor}">${title}</td>`;
                    });
                    tableHTML += '</tr>';

                    setTimeout(() => {
                        flowTable.innerHTML = tableHTML;
                    }, 150);
                } else {
                    flowTable.innerHTML = '<span>無法加載數據</span>';
                }
            })
            .catch(error => {
                flowTable.innerHTML = '<span>請求失敗</span>';
            });
    }

    function countersignPeople() {
        window.open(`Countersign_Peple.html?FormID=${encodedForm_ID}&FM_Step=${encryptParameter(FM_Step)}&AF_ID=${encryptParameter(AF_ID)}&User=${encryptedUser}`, 'add', 'scrollbars=yes,resizable=yes,width=550,height=500,left=250,top=100')
    }

    function counterData() {

        if (!document.querySelector('textarea[name="C_FD_Step_desc"]').value.trim()) {
            alert('請輸入會簽意見');
            return;
        }

        const formData = {
            FM_Source_ID: document.querySelector('input[name="C_FM_Source_ID"]').value,
            FD_Sign_Countersign: 'C',
            FD_Step_SignType: 'FSIGN002',
            FM_Step: FM_Step,
            FD_Step_desc: document.querySelector('textarea[name="C_FD_Step_desc"]').value,
            User: decryptParameter(encryptedUser)
        };

        const url = `${BASE_URL}/AE_AF/AuditFlow_D_Upd`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.resultCode === '000') {
                    alert('會簽完畢');
                    if (window.opener) {
                        window.opener.location.reload();
                    }
                    window.close();
                }
            }).catch(error => {
                alert('請求失敗，請稍後再試。');
            });
    }

    function reviewData() {
        const textareas = document.querySelectorAll('textarea[name="C_FD_Step_desc"]');

        for (let textarea of textareas) {
            if (!textarea.value.trim()) {
                alert('會簽意見尚未填寫完畢');
                return;
            }
        }

        if (document.querySelector('input[name="FD_Step_SignType"]:checked').value === 'FSIGN003') {
            const textdesc = document.querySelector('textarea[name="FD_Step_desc"]');
            if (!textdesc.value.trim()) {
                alert('請填寫駁回意見');
                return;
            }
        }

        if (document.querySelector('input[name="FD_Step_SignType"]:checked').value !== 'FSIGN003') {
            var iframe = document.getElementById('myIframe');
            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            var inputs = iframeDoc.querySelectorAll('input[required]');
            var isValid = true;
            for (var i = 0; i < inputs.length; i++) {
                var input = inputs[i];
                if (!input.value.trim()) {
                    alert("必填請輸入");
                    isValid = false;
                    break;
                }
            }
            if (!isValid) {
                return;
            }
        }

        const formData = {
            FM_Source_ID: FM_Source_ID,
            FD_Sign_Countersign: 'S',
            FD_Step_SignType: document.querySelector('input[name="FD_Step_SignType"]:checked').value,
            FM_Step: FM_Step,
            FD_Step_desc: document.querySelector('textarea[name="FD_Step_desc"]').value,
            User: decryptParameter(encryptedUser)
        };

        const url = `${BASE_URL}/AE_AF/AuditFlow_D_Upd`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.resultCode === '000') {
                    alert('審核完畢');
                    if (window.opener) {
                        window.opener.location.reload();
                    }
                    window.close();
                } else {
                    alert(responseData.ResultMsg);
                }
            }).catch(error => {
                alert('請求失敗，請稍後再試。');
            });
    }
</script>